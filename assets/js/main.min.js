function include_lightbox(){"undefined"==typeof lightbox&&($("head").append('<link id="lightbox-css" href="'+site_url+'assets/plugins/lightbox/css/lightbox.min.css" rel="stylesheet" />'),jQuery.ajax({url:site_url+"assets/plugins/lightbox/js/lightbox.min.js",dataType:"script",cache:!0}))}function init_lightbox(e){if("undefined"!=typeof lightbox){var t={showImageNumberLabel:!1,resizeDuration:200};void 0!==e&&jQuery.extend(t,e),lightbox.option(t)}}function init_progress_bars(){var e=$(".progress .progress-bar");e.length&&e.each(function(){var e=$(this),t=e.attr("data-percent");e.css("width",t+"%"),e.hasClass("no-percent-text")||e.text(t+"%")})}function get_url_param(e){var t={};return window.location.href.replace(location.hash,"").replace(/[?&]+([^=&]+)=?([^&]*)?/gi,function(e,a,i){t[a]=void 0!==i?i:""}),e?t[e]?t[e]:null:t}function mainWrapperHeightFix(){var e=side_bar.height(),t=$(".content").height();setup_menu.css("min-height",$(document).outerHeight(!0)-63+"px"),content_wrapper.css("min-height",$(document).outerHeight(!0)-63+"px"),t<e&&content_wrapper.css("min-height",e+"px"),t<e&&e<$(window).height()&&content_wrapper.css("min-height",$(window).height()-63+"px"),t>e&&t<$(window).height()&&content_wrapper.css("min-height",$(window).height()-63+"px"),is_mobile()&&"true"==isRTL&&side_bar.css("min-height",$(document).outerHeight(!0)-63+"px")}function setBodySmall(){$(this).width()<769?$("body").addClass("page-small"):$("body").removeClass("page-small show-sidebar")}function generatePassword(e){for(var t="abcdefghijklnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",a="",i=0,n=t.length;i<12;++i)a+=t.charAt(Math.floor(Math.random()*n));$(e).parents().find("input.password").val(a)}function switch_field(e){var t,a,i;t=0,1==$(e).prop("checked")&&(t=1),a=$(e).data("switch-url"),i=$(e).data("id"),$.get(a+"/"+i+"/"+t)}function _validate_form(e,t,a){var i=$(e);if(i.length){i.validate({rules:t,messages:{email:{remote:appLang.email_exists}},ignore:[],submitHandler:function(e){if($(e).hasClass("disable-on-submit")&&$(e).find('[type="submit"]').attr("disabled",!0),void 0===a)return!0;a(e)}});var n=i.find("[data-custom-field-required]");n.length>0&&$.each(n,function(){$(this).rules("add",{required:!0});var e=$(this).attr("name"),t=$(this).parents(".form-group").find('[for="'+e+'"]');t.length>0&&0==t.find(".req").length&&t.prepend(' <small class="req text-danger">* </small>')}),$.each(t,function(e,t){if("required"==t&&!jQuery.isPlainObject(t)||jQuery.isPlainObject(t)&&t.hasOwnProperty("required")){var a=i.find('[for="'+e+'"]');a.length>0&&0==a.find(".req").length&&a.prepend(' <small class="req text-danger">* </small>')}})}return!1}function delete_option(e,t){if(0==confirm(appLang.confirm_action_prompt))return!1;$.get(admin_url+"settings/delete_option/"+t,function(t){1==t.success&&$(e).parents(".option").remove()},"json")}function slideToggle(e,t){var a=$(e);a.hasClass("hide")&&a.removeClass("hide","slow"),a.length&&a.slideToggle();var i=$(".progress-bar").not(".not-dynamic");i.length>0&&(i.each(function(){$(this).css("width","0%"),$(this).text("0%")}),init_progress_bars()),"function"==typeof t&&t()}function alert_float(e,t){var a,i;a=$("body").find("float-alert").length,a="alert_float_"+ ++a,i=$('<div id="'+a+'" class="float-alert animated fadeInRight col-xs-11 col-sm-4 alert alert-'+e+'"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><span class="fa fa-bell-o" data-notify="icon"></span><span class="alert-title">'+t+"</span></div>"),$("body").append(i),setTimeout(function(){$("#"+a).hide("fast",function(){$("#"+a).remove()})},3500)}function init_rel_tasks_table(e,t,a){void 0===a&&(a=".table-rel-tasks");var i=$("body").find(a);if(0!=i.length){var n,o,s={},l=2;o=$("._hidden_inputs._filters._tasks_filters input"),$.each(o,function(){s[$(this).attr("name")]='[name="'+$(this).attr("name")+'"]'});var d=admin_url+"tasks/init_relation_tasks/"+e+"/"+t;n=[i.find("th").length-1],"project"==i.attr("data-new-rel-type")&&(l=3,n.push(0),d+="?bulk_actions=true");var r=initDataTable(i,d,n,n,s,[l,"ASC"]);r&&"lead"==t&&r.column($("table .table-tasks-options").index()).visible(!1,!1).columns.adjust()}}function get_dt_export_buttons(e){var t=[{extend:"collection",text:appLang.dt_button_export,className:"btn btn-default-dt-options",buttons:[{extend:"excelHtml5",text:appLang.dt_button_excel,footer:!0,exportOptions:{columns:[":not(.not-export)"]}},{extend:"csvHtml5",text:appLang.dt_button_csv,footer:!0,exportOptions:{columns:[":not(.not-export)"]}},{extend:"pdfHtml5",text:appLang.dt_button_pdf,footer:!0,exportOptions:{columns:[":not(.not-export)"]},orientation:"landscape",customize:function(t){var a=$(e).DataTable().columns().visible(),n=a.length,o=[],s=0;for(i=0;i<n;i++)1==a[i]&&s++;setTimeout(function(){if(s<=5){for(i=0;i<s;i++)o.push(735/s);t.content[1].table.widths=o}},10),t.styles.tableHeader.alignment="left",t.styles.tableHeader.margin=[5,5,5,5],t.pageMargins=[12,12,12,12]}},{extend:"print",text:appLang.dt_button_print,footer:!0,exportOptions:{columns:[":not(.not-export)"]}}]},{extend:"colvis",postfixButtons:["colvisRestore"],className:"btn btn-default-dt-options dt-column-visibility",text:appLang.dt_button_column_visibility},{text:appLang.dt_button_reload,className:"btn btn-default-dt-options",action:function(e,t,a,i){t.ajax.reload()}}];0==app_show_table_columns_visibility&&delete t[1],table_export_button_is_hidden()&&delete t[0];var a=$("body").find(".bulk-actions-btn");return a.length&&a.attr("data-table")&&$(e).is(a.attr("data-table"))&&t.push({text:a.text(),className:"btn btn-default-dt-options",action:function(e,t,i,n){$(a.attr("data-target")).modal("show")}}),t}function table_export_button_is_hidden(){return"to_all"!=app_show_table_export_button&&("hide"==app_show_table_export_button||"only_admins"==app_show_table_export_button&&0==is_admin)}function DataTablesOfflineLazyLoadImages(e,t,a){var i=$("img.img-table-loading",e);return i.attr("src",i.data("orig")),i.prev("div").addClass("hide"),e}function initDataTableOffline(e){var t=".dt-table";void 0!==e&&(t=e);var a=$(t);if(a.length){var i,n,o={language:appLang.datatables,processing:!0,paginate:!0,responsive:!0,autoWidth:!1,order:[0,"DESC"],fnRowCallback:DataTablesOfflineLazyLoadImages,fnDrawCallback:function(e){0==e.aoData.length||0==e.aiDisplay.length?$(e.nTableWrapper).addClass("app_dt_empty"):$(e.nTableWrapper).removeClass("app_dt_empty")},initComplete:function(e,a){var i=this.find(".dataTables_empty");(this.hasClass("scroll-responsive")||1==app_scroll_responsive_tables)&&this.wrap('<div class="table-responsive"></div>'),i.length&&i.attr("colspan",this.find("thead th").length),this.parents(".table-loading").removeClass("table-loading");var n=$(t),o=n.find("thead th:last-child"),s=n.find("thead th:first-child");o.text().trim()==appLang.options&&o.addClass("not-export"),s.find('input[type="checkbox"]').length>0&&s.addClass("not-export")},dom:"<'row'><'row'<'col-md-6'lB><'col-md-6'f>r>t<'row'<'col-md-4'i>><'row'<'#colvis'>p>"},s=$($(this)).attr("data-order-col"),l=$($(this)).attr("data-order-type");$.each(a,function(){i=o,($(this).hasClass("scroll-responsive")||1==app_scroll_responsive_tables)&&(i.responsive=!1),s=$(this).attr("data-order-col"),l=$(this).attr("data-order-type"),s&&l&&(i.order=[[s,l]]),delete(n=get_dt_export_buttons(this))[2],i.buttons=n,$(this).dataTable(i)})}}function initDataTable(e,t,a,i,n,o){var s=$("body").find(e);if(0==s.length)return!1;"undefined"!=n&&void 0!==n||(n=[]),void 0===o?o=[[0,"ASC"]]:1==o.length&&(o=[o]);var l=[10,25,50,100],d=[10,25,50,100];app_tables_pagination_limit=parseFloat(app_tables_pagination_limit),-1==$.inArray(app_tables_pagination_limit,l)&&(l.push(app_tables_pagination_limit),d.push(app_tables_pagination_limit)),l.sort(function(e,t){return e-t}),d.sort(function(e,t){return e-t}),l.push(-1),d.push(appLang.dt_length_menu_all);var r={language:appLang.datatables,processing:!0,retrieve:!0,serverSide:!0,paginate:!0,searchDelay:750,bDeferRender:!0,responsive:!0,autoWidth:!1,dom:"<'row'><'row'<'col-md-7'lB><'col-md-5'f>r>t<'row'<'col-md-4'i>><'row'<'#colvis'>p>",pageLength:app_tables_pagination_limit,lengthMenu:[l,d],columnDefs:[{searchable:!1,targets:a},{sortable:!1,targets:i}],fnDrawCallback:function(e){0==e.aoData.length?$(e.nTableWrapper).addClass("app_dt_empty"):$(e.nTableWrapper).removeClass("app_dt_empty")},fnCreatedRow:function(e,t,a){$(e).attr("data-title",t.Data_Title),$(e).attr("data-toggle",t.Data_Toggle)},initComplete:function(e,t){var a=this;(a.hasClass("scroll-responsive")||1==app_scroll_responsive_tables)&&a.wrap('<div class="table-responsive"></div>');var i=a.find(".dataTables_empty");i.length&&i.attr("colspan",a.find("thead th").length),is_mobile()&&$(window).width()<400&&a.find('tbody td:first-child input[type="checkbox"]').length>0&&(a.DataTable().column(0).visible(!1,!1).columns.adjust(),$("a[data-target*='bulk_actions']").addClass("hide")),a.parents(".table-loading").removeClass("table-loading"),a.removeClass("dt-table-loading");var n=a.find("thead th:last-child"),o=a.find("thead th:first-child");n.text().trim()==appLang.options&&n.addClass("not-export"),o.find('input[type="checkbox"]').length>0&&o.addClass("not-export"),mainWrapperHeightFix()},order:o,ajax:{url:t,type:"POST",data:function(e){for(var t in n)e[t]=$(n[t]).val()}},buttons:get_dt_export_buttons(s)};(s.hasClass("scroll-responsive")||1==app_scroll_responsive_tables)&&(r.responsive=!1);var c=(s=s.dataTable(r)).DataTable(),_=s.find("th.not_visible"),p=[];return $.each(_,function(){p.push(this.cellIndex)}),setTimeout(function(){for(var e in p)c.columns(p[e]).visible(!1,!1).columns.adjust()},10),s.is(":hidden")&&s.find(".dataTables_empty").attr("colspan",s.find("thead th").length),c}function task_single_update_tags(){var e=$("#taskTags");$.post(admin_url+"tasks/update_tags",{tags:e.tagit("assignedTags"),task_id:e.attr("data-taskid")})}function task_attachments_toggle(){$("body").find(".task-attachments-more").toggleClass("hide"),$("body").find(".task-attachments-less").toggleClass("hide")}function update_todo_items(){var e=$(".unfinished-todos li:not(.no-todos)"),t=$(".finished-todos li:not(.no-todos)"),a=1;$.each(e,function(){$(this).find('input[name="todo_order"]').val(a),$(this).find('input[name="finished"]').val(0),a++}),0==e.length?($(".nav-total-todos").addClass("hide"),$(".unfinished-todos li.no-todos").removeClass("hide")):e.length>0&&($(".unfinished-todos li.no-todos").hasClass("hide")||$(".unfinished-todos li.no-todos").addClass("hide"),$(".nav-total-todos").removeClass("hide").html(e.length)),x=1,$.each(t,function(){$(this).find('input[name="todo_order"]').val(x),$(this).find('input[name="finished"]').val(1),$(this).find('input[type="checkbox"]').prop("checked",!0),a++,x++}),0==t.length?$(".finished-todos li.no-todos").removeClass("hide"):t.length>0&&($(".finished-todos li.no-todos").hasClass("hide")||$(".finished-todos li.no-todos").addClass("hide"));var i=[];$.each(e,function(){var e=$(this).find('input[name="todo_id"]').val(),t=$(this).find('input[name="todo_order"]').val(),a=$(this).find('input[name="finished"]').val(),n=$(this).find(".todo-description");n.hasClass("line-throught")&&n.removeClass("line-throught"),$(this).find('input[type="checkbox"]').prop("checked",!1),i.push([e,t,a])}),$.each(t,function(){var e=$(this).find('input[name="todo_id"]').val(),t=$(this).find('input[name="todo_order"]').val(),a=$(this).find('input[name="finished"]').val(),n=$(this).find(".todo-description");n.hasClass("line-throught")||n.addClass("line-throught"),i.push([e,t,a])}),data={},data.data=i,$.post(admin_url+"todo/update_todo_items_order",data)}function delete_todo_item(e,t){$.get(admin_url+"todo/delete_todo_item/"+t,function(t){1==t.success&&($(e).parents("li").remove(),update_todo_items())},"json")}function edit_todo_item(e){$.get(admin_url+"todo/get_by_id/"+e,function(e){var t=$("#__todo");t.find('input[name="todoid"]').val(e.todoid),t.find('textarea[name="description"]').val(e.description),t.modal("show")},"json")}function init_datepicker(){var e=$(".datepicker"),t=$(".datetimepicker");if(0!=t.length||0!=e.length){$.each(e,function(){var e={timepicker:!1,scrollInput:!1,lazyInit:!0,format:app_date_format,dayOfWeekStart:app_calendar_first_day},t=$(this).data("date-end-date"),a=$(this).data("date-min-date");t&&(e.maxDate=t),a&&(e.minDate=a),$(this).datetimepicker(e)});var a;$.each(t,function(){a={lazyInit:!0,scrollInput:!1,dayOfWeekStart:app_calendar_first_day},24==app_time_format?a.format=app_date_format+" H:i":(a.format=app_date_format+" g:i A",a.formatTime="g:i A");var e=$(this).data("date-end-date"),t=$(this).data("date-min-date");e&&(a.maxDate=e),t&&(a.minDate=t),$(this).datetimepicker(a)})}}function init_tags_inputs(){var e=$("body").find("input.tagsinput");e.length&&e.tagit({availableTags:availableTags,allowSpaces:!0,animate:!1,placeholderText:appLang.tag,showAutocompleteOnFocus:!0,caseSensitive:!1,autocomplete:{appendTo:"#inputTagsWrapper"},afterTagAdded:function(e,t){var a=availableTags.indexOf($.trim($(t.tag).find(".tagit-label").text()));if(a>-1){var i=availableTagsIds[a];$(t.tag).addClass("tag-id-"+i)}showHideTagsPlaceholder($(this))},afterTagRemoved:function(e,t){showHideTagsPlaceholder($(this))}})}function init_color_pickers(){var e=$("body").find("div.colorpicker-input");e.length&&e.colorpicker({format:"hex"})}function init_selectpicker(){var e=$("body").find("select.selectpicker");e.length&&e.selectpicker({showSubtext:!0})}function dt_custom_view(e,t,a,i){var n;n=void 0===a?"custom_view":a,void 0!==i&&($("._filters input").val(""),$("._filter_data li.active").removeClass("active"));do_filter_active(n)!=n&&(e=""),$('input[name="'+n+'"]').val(e),$(t).DataTable().ajax.reload()}function do_filter_active(e,t){if(""!=e&&void 0!==e){table_filters_applied=!0,$('[data-cview="all"]').parents("li").removeClass("active");var a=$('[data-cview="'+e+'"]');if(void 0!==t&&(a=$(t+' [data-cview="'+e+'"]')),a.parents("li").not(".dropdown-submenu").hasClass("active")){a.parents("li").not(".dropdown-submenu").removeClass("active");var i=a.parents("li.dropdown-submenu");i.length>0&&0==i.find("li.active").length&&(table_filters_applied=!1,i.removeClass("active")),e=""}else a.parents("li").addClass("active");return e}return table_filters_applied=!0,$("._filters input").val(""),$("._filter_data li.active").removeClass("active"),$('[data-cview="all"]').parents("li").addClass("active"),""}function init_roles_permissions(e,t){if(void 0===e&&(e=$('select[name="role"]').val()),!($('.member > input[name="isedit"]').length>0&&void 0!==e&&void 0===t)&&""!=e){var a=$("table.roles").find("tr");$.get(admin_url+"misc/get_role_permissions_ajax/"+e).done(function(e){e=JSON.parse(e);var t,i;$.each(a,function(){var a=$(this).data("id"),n=$(this);$.each(e,function(e,o){a==o.permissionid&&(t=1==o.can_view,i=1==o.can_view_own,n.find("[data-can-view]").prop("checked",t),1==t&&n.find("[data-can-view]").change(),n.find("[data-can-view-own]").prop("checked",i),1==i&&n.find("[data-can-view-own]").change(),n.find("[data-can-edit]").prop("checked",1==o.can_edit),n.find("[data-can-create]").prop("checked",1==o.can_create),n.find("[data-can-delete]").prop("checked",1==o.can_delete))})})})}}function hidden_input(e,t){return'<input type="hidden" name="'+e+'" value="'+t+'">'}function toggle_small_view(e,t){$("body").toggleClass("small-table");var a=$("#small-table");if(0!=a.length){var i=!1;a.hasClass("col-md-5")?(a.removeClass("col-md-5").addClass("col-md-12"),i=!0,$(".toggle-small-view").find("i").removeClass("fa fa-angle-double-right").addClass("fa fa-angle-double-left")):(a.addClass("col-md-5").removeClass("col-md-12"),$(".toggle-small-view").find("i").removeClass("fa fa-angle-double-left").addClass("fa fa-angle-double-right"));var n=$(e).DataTable();n.columns(hidden_columns).visible(i,!1),n.columns.adjust(),$(t).toggleClass("hide")}}function stripTags(e){var t=document.createElement("DIV");return t.innerHTML=e,t.textContent||t.innerText||""}function empty(e){if("number"==typeof e||"boolean"==typeof e)return!1;if(void 0===e||null===e)return!0;if(void 0!==e.length)return 0==e.length;var t=0;for(var a in e)e.hasOwnProperty(a)&&t++;return 0==t}function is_mobile(){return app_is_mobile}function logout(){if($(".started-timers-top").find("li.timer").length>0)return $(".timers-modal-logout").modal("show"),!1;window.location.href=site_url+"authentication/logout"}function color(e,t,a){return"rgb("+e+","+t+","+a+")"}function buildUrl(e,t){var a="";for(var i in t){var n=t[i];a+=encodeURIComponent(i)+"="+encodeURIComponent(n)+"&"}return a.length>0&&(e=e+"?"+(a=a.substring(0,a.length-1))),e}function decimalToHM(e){var t=parseInt(Number(e)),a=Math.round(60*(Number(e)-t));return(t<10?"0"+t:t)+":"+(a<10?"0"+a:a)}function elFinderBrowser(e,t,a,i){return tinymce.activeEditor.windowManager.open({file:admin_url+"misc/tinymce_file_browser",title:appLang.media_files,width:900,height:450,resizable:"yes"},{setUrl:function(t){i.document.getElementById(e).value=t}}),!1}function init_editor(e,t){void 0===e&&(e=".tinymce");var a=$(e);if(0!=a.length){$.each(a,function(){$(this).hasClass("tinymce-manual")&&$(this).removeClass("tinymce")});var i={selector:e,browser_spellcheck:!0,height:400,theme:"modern",skin:"perfex",language:tinymce_lang,relative_urls:!1,inline_styles:!0,verify_html:!1,cleanup:!1,valid_elements:"+*[*]",valid_children:"+body[style], +style[type]",apply_source_formatting:!1,remove_script_host:!1,removed_menuitems:"newdocument",forced_root_block:!1,autosave_restore_when_empty:!1,fontsize_formats:"8pt 10pt 12pt 14pt 18pt 24pt 36pt",setup:function(e){e.on("init",function(){this.getDoc().body.style.fontSize="12pt"}),e.addMenuItem("codesample",{text:"Insert/Edit code sample",context:"insert",icon:"codesample",onclick:function(){tinyMCE.execCommand("codesample")}})},table_default_styles:{width:"100%"},plugins:["advlist autoresize autosave autolink lists link image charmap print preview hr anchor codesample","searchreplace wordcount visualblocks visualchars code fullscreen","media nonbreaking save table contextmenu directionality","paste textcolor colorpicker"],toolbar1:"fontselect fontsizeselect | forecolor backcolor | bold italic | alignleft aligncenter alignright alignjustify | image link | bullist numlist | restoredraft",file_browser_callback:elFinderBrowser};if("true"==isRTL&&(i.directionality="rtl"),void 0!==t)for(var n in t)i[n]=t[n];return tinymce.init(i)}}function _formatMenuIconInput(e){if(void 0!==e){var t=$(e.target);t.val().match(/^fa /)||t.val("fa "+t.val())}}function showPassword(e){var t=$('input[name="'+e+'"]');"password"==$(t).attr("type")&&""!=$(t).val()?$(t).queue(function(){$(t).attr("type","text").dequeue()}):$(t).queue(function(){$(t).attr("type","password").dequeue()})}function init_btn_with_tooltips(){if(is_mobile()){var e=$("._buttons").find(".btn-with-tooltip");$.each(e,function(){var e=$(this).attr("title");void 0===e&&(e=$(this).attr("data-title")),void 0!==e&&($(this).append(" "+e),$(this).removeClass("btn-with-tooltip"))});var t=$("._buttons").find(".btn-with-tooltip-group");$.each(t,function(){var e=$(this).attr("title");void 0===e&&(e=$(this).attr("data-title")),void 0!==e&&($(this).find(".btn").eq(0).append(" "+e),$(this).removeClass("btn-with-tooltip-group"))})}}function do_hash_helper(e){if(void 0!==history.pushState){var t={Url:window.location.href};history.pushState(t,"",t.Url),window.location.hash=e}}function manage_kb_groups(e){var t=$(e).serialize(),a=e.action;return $.post(a,t).done(function(e){window.location.reload()}),!1}function new_kb_group(){$("#kb_group_modal").modal("show"),$(".edit-title").addClass("hide")}function edit_kb_group(e,t){$("#additional").append(hidden_input("id",t)),$('#kb_group_modal input[name="name"]').val($(e).data("name")),$('#kb_group_modal textarea[name="description"]').val($(e).data("description")),$("#kb_group_modal .colorpicker-input").colorpicker("setValue",$(e).data("color")),$('#kb_group_modal input[name="group_order"]').val($(e).data("order")),0==$(e).data("active")?$('input[name="disabled"]').prop("checked",!0):$('input[name="disabled"]').prop("checked",!1),$("#kb_group_modal").modal("show"),$(".add-title").addClass("hide")}function init_form_reminder(){var e=$('[id^="form-reminder-"]');$.each(e,function(e,t){_validate_form($(t),{date:"required",staff:"required"},reminderFormHandler)})}function reminderFormHandler(e){var t=(e=$(e)).serialize(),a=$(e).serializeArray();return $.post(e.attr("action"),t).done(function(e){alert_float((e=JSON.parse(e)).alert_type,e.message),reload_reminders_tables()}),$(".reminder-modal-"+a[1].value+"-"+a[0].value).modal("hide"),!1}function reload_reminders_tables(){$.each(available_reminders_table,function(e,t){$.fn.DataTable.isDataTable(t)&&$("body").find(t).DataTable().ajax.reload()})}function close_modal_manually(e){(e=0==$(e).length?$("body").find(e):$(e)).fadeOut("fast",function(){e.remove(),$("body").find(".modal").is(":visible")||($(".modal-backdrop").remove(),$("body").removeClass("modal-open"))})}function toggle_edit_note(e){$("body").find('[data-note-edit-textarea="'+e+'"]').toggleClass("hide"),$("body").find('[data-note-description="'+e+'"]').toggleClass("hide")}function edit_note(e){var t=$("body").find('[data-note-edit-textarea="'+e+'"] textarea').val();""!=t&&($.post(admin_url+"misc/edit_note/"+e,{description:t}).done(function(a){1==(a=JSON.parse(a)).success&&(alert_float("success",a.message),$("body").find('[data-note-description="'+e+'"]').html(nl2br(t)))}),toggle_edit_note(e))}function toggle_file_visibility(e,t,a){$.get(admin_url+"misc/toggle_file_visibility/"+e,function(e){1==e?$(a).find("i").removeClass("fa fa-toggle-off").addClass("fa fa-toggle-on"):$(a).find("i").removeClass("fa fa-toggle-on").addClass("fa fa-toggle-off")})}function nl2br(e,t){var a=t||void 0===t?"<br />":"<br>";return(e+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+a+"$2")}function fix_kanban_height(e,t){$("body").find("div.dt-loader").remove();var a=$(".kan-ban-content-wrapper");a.css("max-height",window.innerHeight-e+"px"),$(".kan-ban-content").css("min-height",window.innerHeight-e+"px");var i=parseInt(a.length);$(".container-fluid").css("min-width",i*t+"px")}function kanban_load_more(e,t,a,i,n){var o,s=[],l=$('input[name="search"]').val(),d=$(t).attr("data-page"),r=$('[data-col-status-id="'+e+'"]').data("total-pages");if(d<=r){var c=$('input[name="sort_type"]'),_=$('input[name="sort"]').val();0!=c.length&&""!=c.val()&&(s.sort_by=c.val(),s.sort=_),""!=l&&(s.search=l),$.each($("#kanban-params input"),function(){""!=(o=$(this).val())&&(s[$(this).attr("name")]=o)}),s.status=e,s.page=d,s.page++,$.get(buildUrl(admin_url+a,s),function(a){d++,$('[data-load-status="'+e+'"]').before(a),$(t).attr("data-page",d),fix_kanban_height(i,n)}).fail(function(e){alert_float("danger",e.responseText)}),d>=r-1&&$(t).addClass("disabled")}}function check_kanban_empty_col(e){var t=$("[data-col-status-id]");$.each(t,function(t,a){0==$(a).find(e).length?($(a).find(".kanban-empty").removeClass("hide"),$(a).find(".kanban-load-more").addClass("hide")):$(a).find(".kanban-empty").addClass("hide")})}function init_kanban(e,t,a,i,n,o){if(0!=$("#kan-ban").length){var s,l=[];$.each($("#kanban-params input"),function(){""!=(s=$(this).val())&&(l[$(this).attr("name")]=s)});var d=$('input[name="search"]').val();""!==d&&(l.search=d);var r=$('input[name="sort_type"]'),c=$('input[name="sort"]').val();0!=r.length&&""!=r.val()&&(l.sort_by=r.val(),l.sort=c),l.kanban=!0;var e=admin_url+e;e=buildUrl(e,l),delay(function(){$("body").append('<div class="dt-loader"></div>'),$("#kan-ban").load(e,function(){fix_kanban_height(i,n),void 0!==o&&o(),$(".status").sortable({connectWith:a,helper:"clone",appendTo:"#kan-ban",placeholder:"ui-state-highlight-card",revert:"invalid",scroll:!0,scrollSensitivity:50,scrollSpeed:70,drag:function(e,t){var a=parseInt($(this).data("startingScrollTop"));t.position.top-=$(this).parent().scrollTop()-a},start:function(e,t){$(t.helper).addClass("tilt"),$(t.helper).find(".panel-body").css("background","#fbfbfb"),tilt_direction($(t.helper))},stop:function(e,t){$(t.helper).removeClass("tilt"),$("html").off("mousemove",$(t.helper).data("move_handler")),$(t.helper).removeData("move_handler")},update:function(e,a){t(a,this)}}),$(".status").sortable({cancel:".not-sortable"})})},200)}}function tilt_direction(e){setTimeout(function(){var t=e.position().left,a=function(a){a.pageX>=t?(e.addClass("right"),e.removeClass("left")):(e.addClass("left"),e.removeClass("right")),t=a.pageX};$("html").on("mousemove",a),e.data("move_handler",a)},1e3)}function init_newsfeed_form(){"undefined"==typeof newsFeedDropzone&&$("body").on("submit","#new-post-form",function(){return $.post(this.action,$(this).serialize()).done(function(e){if((e=JSON.parse(e)).postid){if(newsFeedDropzone.getQueuedFiles().length>0)return newsFeedDropzone.options.url=admin_url+"newsfeed/add_post_attachments/"+e.postid,void newsFeedDropzone.processQueue();newsfeed_new_post(e.postid),clear_newsfeed_post_area()}}),!1}),newsFeedDropzone=new Dropzone("#new-post-form",{clickable:".add-post-attachments",autoProcessQueue:!1,addRemoveLinks:!0,parallelUploads:app_newsfeed_maximum_files_upload,maxFiles:app_newsfeed_maximum_files_upload,maxFilesize:app_newsfeed_maximum_file_size,acceptedFiles:app_allowed_files,dictDefaultMessage:appLang.drop_files_here_to_upload,dictFallbackMessage:appLang.browser_not_support_drag_and_drop,dictRemoveFile:appLang.remove_file,dictMaxFilesExceeded:appLang.you_can_not_upload_any_more_files}),newsFeedDropzone.on("success",function(e,t){0==--total_new_post_files&&(newsfeed_new_post((t=JSON.parse(t)).postid),clear_newsfeed_post_area(),newsFeedDropzone.removeAllFiles())}),newsFeedDropzone.on("dragover",function(e){$("#new-post-form").addClass("dropzone-active")}),newsFeedDropzone.on("drop",function(e){$("#new-post-form").removeClass("dropzone-active")}),newsFeedDropzone.on("error",function(e,t){total_new_post_files--,alert_float("danger",t)}),newsFeedDropzone.on("removedfile",function(e){total_new_post_files--}),newsFeedDropzone.on("addedfile",function(e){0==this.getQueuedFiles().length&&(total_new_post_files=0),total_new_post_files++})}function clear_newsfeed_post_area(){$("#new-post-form textarea").val(""),$("#post-visibility").selectpicker("val","all")}function load_post_likes(e){track_load_post_likes<=post_likes_total_pages&&($.post(admin_url+"newsfeed/load_likes_modal",{page:track_load_post_likes,postid:e}).done(function(e){track_load_post_likes++,$("#modal_post_likes_wrapper").append(e)}),track_load_post_likes>=post_likes_total_pages-1&&$(".likes_modal .modal-footer").addClass("hide"))}function load_comment_likes(e){track_load_comment_likes<=comment_likes_total_pages&&($.post(admin_url+"newsfeed/load_comment_likes_model",{page:track_load_comment_likes,commentid:e}).done(function(e){track_load_comment_likes++,$("#modal_comment_likes_wrapper").append(e)}),track_load_comment_likes>=comment_likes_total_pages-1&&$(".likes_modal .modal-footer").addClass("hide"))}function load_more_comments(e){var t=$(e).data("postid"),a=$(e).find('input[name="page"]').val(),i=$(e).data("total-pages");a<=i&&($.post(admin_url+"newsfeed/init_post_comments/"+t,{page:a}).done(function(i){$(e).data("track-load-comments",a),$('[data-comments-postid="'+t+'"] .load-more-comments').before(i)}),a++,$(e).find('input[name="page"]').val(a),a>=i-1&&($(e).addClass("hide"),$(e).removeClass("display-block")))}function newsfeed_new_post(e){var t={};t.postid=e,$.post(admin_url+"newsfeed/load_newsfeed",t).done(function(e){var t=$("#newsfeed_data").find(".pinned").length;if(0==t)$("#newsfeed_data").prepend(e);else{var a=$("#newsfeed_data").find(".pinned").eq(t-1);$(a).after(e)}})}function load_newsfeed(e){var t={};t.page=newsfeed_posts_page,void 0!==e&&0!=e&&(t.postid=e);var a=$('input[name="total_pages_newsfeed"]').val();newsfeed_posts_page<=a&&$.post(admin_url+"newsfeed/load_newsfeed",t).done(function(e){newsfeed_posts_page++,$("#newsfeed_data").append(e)})}function like_post(e){$.get(admin_url+"newsfeed/like_post/"+e,function(t){1==t.success&&refresh_post_likes(e)},"json")}function unlike_post(e){$.get(admin_url+"newsfeed/unlike_post/"+e,function(t){1==t.success&&refresh_post_likes(e)},"json")}function like_comment(e,t){$.get(admin_url+"newsfeed/like_comment/"+e+"/"+t,function(t){1==t.success&&$('[data-commentid="'+e+'"]').replaceWith(t.comment)},"json")}function unlike_comment(e,t){$.get(admin_url+"newsfeed/unlike_comment/"+e+"/"+t,function(t){1==t.success&&$('[data-commentid="'+e+'"]').replaceWith(t.comment)},"json")}function add_comment(e){var t=$(e).data("postid");$.post(admin_url+"newsfeed/add_comment",{content:$(e).val(),postid:t}).done(function(a){1==(a=JSON.parse(a)).success&&($(e).val(""),$("body").find('[data-comments-postid="'+t+'"] .post-comment').length>0?$("body").find('[data-comments-postid="'+t+'"] .post-comment').prepend(a.comment):refresh_post_comments(t))})}function remove_post_comment(e,t){$.get(admin_url+"newsfeed/remove_post_comment/"+e+"/"+t,function(t){1==t.success&&$('.comment[data-commentid="'+e+'"]').remove()},"json")}function refresh_post_likes(e){$.get(admin_url+"newsfeed/init_post_likes/"+e+"?refresh_post_likes=true",function(t){$('[data-likes-postid="'+e+'"]').html(t)})}function refresh_post_comments(e){$.post(admin_url+"newsfeed/init_post_comments/"+e+"?refresh_post_comments=true").done(function(t){$('[data-comments-postid="'+e+'"]').html(t)})}function delete_post(e){if(0==confirm(appLang.confirm_action_prompt))return!1;$.post(admin_url+"newsfeed/delete_post/"+e,function(t){1==t.success&&$('[data-main-postid="'+e+'"]').remove()},"json")}function pin_post(e){$.get(admin_url+"newsfeed/pin_newsfeed_post/"+e,function(e){1==e.success&&window.location.reload()},"json")}function unpin_post(e){$.get(admin_url+"newsfeed/unpin_newsfeed_post/"+e,function(e){1==e.success&&window.location.reload()},"json")}function init_lead(e){$("#task-modal").is(":visible")&&$("#task-modal").modal("hide"),init_lead_modal_data(e)&&$("#lead-modal").modal("show")}function validate_lead_form(e){_validate_form($("#lead_form"),{name:"required",status:{required:{depends:function(e){return!($("[lead-is-junk-or-lost]").length>0)}}},source:"required",email:{email:!0,remote:{url:admin_url+"leads/email_exists",type:"post",data:{email:function(){return $('input[name="email"]').val()},leadid:function(){return $('input[name="leadid"]').val()}}}}},e)}function validate_lead_convert_to_client_form(){var e={firstname:"required",lastname:"required",password:{required:{depends:function(e){if(0==$('input[name="send_set_password_email"]').prop("checked"))return!0}}},email:{required:!0,email:!0,remote:{url:site_url+"admin/misc/contact_email_exists",type:"post",data:{email:function(){return $('#lead_to_client_form input[name="email"]').val()},userid:""}}}};1==app_company_is_required&&(e.company="required"),_validate_form($("#lead_to_client_form"),e)}function lead_profile_form_handler(e){var t=(e=$(e)).serialize(),a=($(e).serializeArray(),$("#lead-modal").find('input[name="leadid"]').val());return $.post(e.attr("action"),t).done(function(e){(e=JSON.parse(e)).id&&(a=e.id),""!=e.message&&alert_float("success",e.message),e.proposal_warning&&0!=e.proposal_warning?($("body").find("#lead_proposal_warning").removeClass("hide"),$("body").find("#lead-modal").animate({scrollTop:0},800)):init_lead_modal_data(a),$.fn.DataTable.isDataTable(".table-leads")&&$(".table-leads").DataTable().ajax.reload(null,!1)}).fail(function(e){return alert_float("danger",e.responseText),!1}),!1}function update_all_proposal_emails_linked_to_lead(e){$.post(admin_url+"leads/update_all_proposal_emails_linked_to_lead/"+e,{update:!0}).done(function(t){(t=JSON.parse(t)).success&&alert_float("success",t.message),init_lead_modal_data(e)})}function init_lead_modal_data(e,t){void 0===e&&(e="");var a=admin_url+"leads/lead/"+e;void 0!==t&&(a=t);var i=window.location.hash;$.get(a,function(t){if($("#lead-modal .data").html(t.data),$("#lead_reminder_modal").html(t.reminder_data),init_tags_inputs(),$("#lead-modal").modal({show:!0,backdrop:"static"}),init_selectpicker(),init_form_reminder(),init_datepicker(),init_color_pickers(),validate_lead_form(lead_profile_form_handler),"#tab_lead_profile"!=i&&"#attachments"!=i&&"#lead_notes"!=i||(window.location.hash=i),""!=e){"undefined"!=typeof Dropbox&&document.getElementById("dropbox-chooser-lead").appendChild(Dropbox.createChooseButton({success:function(t){$.post(admin_url+"leads/add_external_attachment",{files:t,lead_id:e,external:"dropbox"}).done(function(){init_lead_modal_data(e)})},linkType:"preview",extensions:app_allowed_files.split(",")})),"undefined"!=typeof leadAttachmentsDropzone&&leadAttachmentsDropzone.destroy(),leadAttachmentsDropzone=new Dropzone("#lead-attachment-upload",{addRemoveLinks:!0,dictDefaultMessage:appLang.drop_files_here_to_upload,dictRemoveFile:appLang.remove_file,dictCancelUpload:appLang.cancel_upload,dictFileTooBig:appLang.file_exceeds_maxfile_size_in_form,dictMaxFilesExceeded:appLang.you_can_not_upload_any_more_files,maxFilesize:(max_php_ini_upload_size_bytes/1048576).toFixed(0),dictFallbackMessage:appLang.browser_not_support_drag_and_drop,sending:function(t,a,i){i.append("leadid",e)},acceptedFiles:app_allowed_files,error:function(e,t){alert_float("danger",t)},success:function(t){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&init_lead_modal_data(e)}}),$("body").find('.nav-tabs a[href="'+window.location.hash+'"]').tab("show");var a=$("#lead_activity").find(".feed-item:last-child .text").html();void 0!==a?$("#lead-latest-activity").html(a):$(".lead-latest-activity > .lead-info-heading").addClass("hide")}},"json").fail(function(e){$("#lead-modal").modal("hide"),alert_float("danger",e.responseText)})}function leads_kanban_sort(e){var t=$('input[name="sort_type"]'),a=$('input[name="sort"]');t.val(e),"ASC"==a.val()?a.val("DESC"):"DESC"==a.val()?a.val("ASC"):a.val("DESC"),leads_kanban()}function leads_kanban_update(e,t){if(t===e.item.parent()[0]){var a={};a.status=$(e.item.parent()[0]).data("lead-status-id"),a.leadid=$(e.item).data("lead-id");var i=[],n=$(e.item).parents(".leads-status").find("li"),o=1;$.each(n,function(){i.push([$(this).data("lead-id"),o]),o++}),a.order=i,setTimeout(function(){$.post(admin_url+"leads/update_kan_ban_lead_status",a).done(function(e){check_kanban_empty_col("[data-lead-id]")})},200)}}function init_leads_status_sortable(){$("#kan-ban").sortable({helper:"clone",item:".kan-ban-col",update:function(e,t){var a=[],i=$(".kan-ban-col"),n=0;$.each(i,function(){a.push([$(this).data("col-status-id"),n]),n++});var o={};o.order=a,$.post(admin_url+"leads/update_status_order",o)}})}function leads_kanban(e){init_kanban("leads",leads_kanban_update,".leads-status",310,360,init_leads_status_sortable)}function delete_lead_attachment(e,t){if(0==confirm(appLang.confirm_action_prompt))return!1;$.get(admin_url+"leads/delete_attachment/"+t,function(t){1==t.success&&$(e).parents(".lead-attachment-wrapper").remove()},"json").fail(function(e){$("#lead-modal").modal("hide"),alert_float("danger",e.responseText)})}function delete_lead_note(e,t){if(0==confirm(appLang.confirm_action_prompt))return!1;$.get(admin_url+"leads/delete_note/"+t,function(t){1==t.success&&$(e).parents(".lead-note").remove()},"json").fail(function(e){$("#lead-modal").modal("hide"),alert_float("danger",e.responseText)})}function lead_mark_as_lost(e){$.get(admin_url+"leads/mark_as_lost/"+e,function(t){1==t.success&&(alert_float("success",t.message),$("body").find("tr#lead_"+e).remove(),$("body").find('#kan-ban li[data-lead-id="'+e+'"]').remove()),init_lead_modal_data(e)},"json").fail(function(e){alert_float("danger",e.responseText)})}function lead_unmark_as_lost(e){$.get(admin_url+"leads/unmark_as_lost/"+e,function(t){1==t.success&&alert_float("success",t.message),init_lead_modal_data(e)},"json").fail(function(e){alert_float("danger",e.responseText)})}function lead_mark_as_junk(e){$.get(admin_url+"leads/mark_as_junk/"+e,function(t){1==t.success&&(alert_float("success",t.message),$("body").find("tr#lead_"+e).remove(),$("body").find('#kan-ban li[data-lead-id="'+e+'"]').remove()),init_lead_modal_data(e)},"json").fail(function(e){alert_float("danger",e.responseText)})}function lead_unmark_as_junk(e){$.get(admin_url+"leads/unmark_as_junk/"+e,function(t){1==t.success&&alert_float("success",t.message),init_lead_modal_data(e)},"json").fail(function(e){alert_float("danger",e.responseText)})}function manage_leads_statuses(e){var t=$(e).serialize(),a=e.action;return $.post(a,t).done(function(e){window.location.reload()}),!1}function convert_lead_to_customer(e){$("#lead-modal").modal("hide"),$.get(admin_url+"leads/get_convert_data/"+e,function(e){$("#lead_convert_to_customer").html(e),$("#convert_lead_to_client_modal").modal({show:!0,backdrop:"static",keyboard:!1})}).fail(function(e){$("#lead-modal").modal("hide"),alert_float("danger",e.responseText)})}function new_status(){$("#status").modal("show"),$(".edit-title").addClass("hide")}function edit_status(e,t){$("#additional").append(hidden_input("id",t)),$('#status input[name="name"]').val($(e).data("name")),$("#status .colorpicker-input").colorpicker("setValue",$(e).data("color")),$('#status input[name="statusorder"]').val($(e).data("order")),$("#status").modal("show"),$(".add-title").addClass("hide")}function leads_bulk_action(e){if(0==confirm(appLang.confirm_action_prompt))return!1;var t=$("#mass_delete").prop("checked"),a=[],i={};if(0==t||void 0===t){if(i.status=$("#move_to_status_leads_bulk").val(),i.assigned=$("#assign_to_leads_bulk").val(),i.source=$("#move_to_source_leads_bulk").val(),i.last_contact=$("#leads_bulk_last_contact").val(),i.tags=$("#tags_bulk").tagit("assignedTags"),i.visibility=$('input[name="leads_bulk_visibility"]:checked').val(),void 0===i.assigned&&(i.assigned=""),void 0===i.visibility&&(i.visibility=""),""==i.status&&""==i.assigned&&""==i.source&&""==i.last_contact&&""==i.tags&&""==i.visibility)return}else i.mass_delete=!0;var n=$(".table-leads").find("tbody tr");$.each(n,function(){var e=$($(this).find("td").eq(0)).find("input");1==e.prop("checked")&&a.push(e.val())}),i.ids=a,$(e).addClass("disabled"),setTimeout(function(){$.post(admin_url+"leads/bulk_action",i).done(function(){window.location.reload()}).fail(function(e){$("#lead-modal").modal("hide"),alert_float("danger",e.responseText)})},200)}function sync_proposals_data(e,t){var a={},i=$("#sync_data_proposal_data");a.country=i.find('select[name="country"]').val(),a.zip=i.find('input[name="zip"]').val(),a.state=i.find('input[name="state"]').val(),a.city=i.find('input[name="city"]').val(),a.address=i.find('input[name="address"]').val(),a.phone=i.find('input[name="phone"]').val(),a.rel_id=e,a.rel_type=t,$.post(admin_url+"proposals/sync_data",a).done(function(e){alert_float("success",(e=JSON.parse(e)).message),i.modal("hide")})}function init_table_announcements(e){if(void 0===e&&$("body").hasClass("home"))return!1;initDataTable(".table-announcements",admin_url+"announcements",[2],[2],"undefined",[1,"DESC"])}function init_table_tickets(e){if(void 0===e&&$("body").hasClass("home"))return!1;if(0!=$("body").find(".tickets-table").length){var t=$(".tickets-table").find("th").length-1,a={},i=$("._hidden_inputs._filters.tickets_filters input"),n=$("table.tickets-table thead .ticket_created_column").index();$.each(i,function(){a[$(this).attr("name")]='[name="'+$(this).attr("name")+'"]'}),a.project_id='[name="project_id"]';var o=[t],s=admin_url+"tickets";$("body").hasClass("tickets_page")&&(o.push(0),s+="?bulk_actions=true"),_table_api=initDataTable(".tickets-table",s,o,o,a,[n,"DESC"]),_table_api&&$("body").hasClass("home")&&_table_api.column(t).visible(!1,!1).column(3).visible(!1,!1).column(n).visible(!1,!1).column(4).visible(!1,!1).column(5).visible(!1,!1).columns.adjust()}}function init_table_staff_projects(e){if(void 0===e&&$("body").hasClass("home"))return!1;if(0!=$("body").find(".table-staff-projects").length){var t={},a=$("._hidden_inputs._filters.staff_projects_filter input");$.each(a,function(){t[$(this).attr("name")]='[name="'+$(this).attr("name")+'"]'}),initDataTable(".table-staff-projects",admin_url+"projects/staff_projects","undefined","undefined",t,[2,"ASC"])}}function do_task_checklist_items_height(e){void 0===e&&(e=$("body").find("textarea[name='checklist-description']")),$.each(e,function(){var e=$(this).val();$(this).outerHeight()<this.scrollHeight+parseFloat($(this).css("borderTopWidth"))+parseFloat($(this).css("borderBottomWidth"))&&($(this).height(0).height(this.scrollHeight),$(this).parents(".checklist").height(this.scrollHeight)),""==e&&($(this).removeAttr("style"),$(this).parents(".checklist").removeAttr("style"))})}function recalculate_checklist_items_progress(){var e=$('input[name="checklist-box"]:checked').length,t=$('input[name="checklist-box"]').length,a=0,i=$(".task-progress-bar");if(0==t?($("body").find(".chk-heading").remove(),$("#task-no-checklist-items").removeClass("hide")):$("#task-no-checklist-items").addClass("hide"),!(t>2))return i.parents(".progress").addClass("hide"),!1;i.parents(".progress").removeClass("hide"),a=100*e/t,i.css("width",a.toFixed(2)+"%"),i.text(a.toFixed(2)+"%")}function delete_checklist_item(e,t){$.get(admin_url+"tasks/delete_checklist_item/"+e,function(e){1==e.success&&($(t).parents(".checklist").remove(),recalculate_checklist_items_progress())},"json")}function remove_checklist_item_template(e){$.get(admin_url+"tasks/remove_checklist_item_template/"+e,function(t){if(1==t.success){var a=$("body").find("select.checklist-items-template-select"),i=a.find('option[value="'+e+'"]').html().trim(),n=$("#task-modal .checklist");$.each(n,function(e,t){var a=$(t);a.find('textarea[name="checklist-description"]').val().trim()==i&&a.find(".save-checklist-template").removeClass("hide")}),a.find('option[value="'+e+'"]').remove(),a.selectpicker("refresh"),1==a.find("option").length&&(a.selectpicker("destroy"),$(".checklist-templates-wrapper").addClass("hide"))}},"json")}function save_checklist_item_template(e,t){var a=$('.checklist[data-checklist-id="'+e+'"] textarea').val();$.post(admin_url+"tasks/save_checklist_item_template",{description:a}).done(function(e){e=JSON.parse(e),$(t).addClass("hide");var i=$(".checklist-templates-wrapper");i.find('select option[value=""]').after('<option value="'+e.id+'">'+a.trim()+"</option>"),i.removeClass("hide"),i.find("select").selectpicker("refresh")})}function update_checklist_order(){var e=[],t=$("body").find(".checklist");if(0!=t.length){var a=1;$.each(t,function(){e.push([$(this).data("checklist-id"),a]),a++});var i={};i.order=e,$.post(admin_url+"tasks/update_checklist_order",i)}}function add_task_checklist_item(e,t){void 0===t&&(t=""),$.post(admin_url+"tasks/add_checklist_item",{taskid:e,description:t}).done(function(){init_tasks_checklist_items(!0,e)})}function init_tasks_checklist_items(e,t){$.post(admin_url+"tasks/init_checklist_items",{taskid:t}).done(function(t){if($("#checklist-items").html(t),void 0!==e){var a=$("#checklist-items").find(".checklist textarea").eq(0);""==a.val()&&a.focus()}recalculate_checklist_items_progress(),update_checklist_order()})}function remove_task_attachment(e,t){if(0==confirm(appLang.confirm_action_prompt))return!1;$.get(admin_url+"tasks/remove_task_attachment/"+t,function(e){1==e.success&&$('[data-task-attachment-id="'+t+'"]').remove();var a=$("body").find(".task_attachments_wrapper"),i=a.find(".task-attachment-col"),n=$("body").find("#show-more-less-task-attachments-col .task-attachments-more");0==i.length?a.remove():2==i.length&&n.hasClass("hide")?$("body").find("#show-more-less-task-attachments-col").remove():0!=$(".task-attachment-col:visible").length||n.hasClass("hide")||n.click()},"json")}function add_task_comment(e){var t={};t.content=tinyMCE.activeEditor.getContent(),t.taskid=e,$.post(admin_url+"tasks/add_task_comment",t).done(function(t){init_task_modal(e)})}function remove_task_comment(e){if(0==confirm(appLang.confirm_action_prompt))return!1;$.get(admin_url+"tasks/remove_comment/"+e,function(t){1==t.success&&$('[data-commentid="'+e+'"]').remove()},"json")}function remove_assignee(e,t){if(0==confirm(appLang.confirm_action_prompt))return!1;$.get(admin_url+"tasks/remove_assignee/"+e+"/"+t,function(e){1==e.success?alert_float("success",e.message):alert_float("warning",e.message),init_task_modal(t)},"json")}function remove_follower(e,t){if(0==confirm(appLang.confirm_action_prompt))return!1;$.get(admin_url+"tasks/remove_follower/"+e+"/"+t,function(e){1==e.success&&(alert_float("success",e.message),init_task_modal(t))},"json")}function mark_complete(e){if(0===$("#task-single-mark-complete-btn").length)return!1;task_mark_as(5,e,admin_url+"tasks/mark_complete/"+e)}function unmark_complete(e){if(0===$("#task-single-unmark-complete-btn").length)return!1;task_mark_as(4,e,admin_url+"tasks/unmark_complete/"+e)}function task_mark_as(e,t,a){void 0===a&&(a=admin_url+"tasks/mark_as/"+e+"/"+t),$("body").append('<div class="dt-loader"></div>'),$.get(a,function(a){$("body").find(".dt-loader").remove(),1==a.success&&(reload_tasks_tables(),$("#task-modal").is(":visible")&&init_task_modal(t),5==e&&_maybe_remove_task_from_project_milestone(t),0==$(".tasks-kanban").length&&alert_float("success",a.message))},"json")}function _maybe_remove_task_from_project_milestone(e){var t=$(".milestone-tasks-wrapper");$("body").hasClass("project")&&t.length>0&&1==$("#exclude_completed_tasks").prop("checked")&&t.find('[data-task-id="'+e+'"]').remove()}function reload_tasks_tables(){$.fn.DataTable.isDataTable(".table-tasks")&&$(".table-tasks").DataTable().ajax.reload(null,!1),$.fn.DataTable.isDataTable(".table-rel-tasks")&&$(".table-rel-tasks").DataTable().ajax.reload(null,!1),$.fn.DataTable.isDataTable(".table-rel-tasks-leads")&&$(".table-rel-tasks-leads").DataTable().ajax.reload(null,!1),$.fn.DataTable.isDataTable(".table-timesheets")&&$(".table-timesheets").DataTable().ajax.reload(null,!1)}function make_task_public(e){$.get(admin_url+"tasks/make_public/"+e,function(t){1==t.success&&(reload_tasks_tables(),init_task_modal(e))},"json")}function new_task(e){var t=admin_url+"tasks/task";void 0!==e&&(t=e);var a=$("#lead-modal");a.is(":visible")&&(-1===(t+="&opened_from_lead_id="+a.find('input[name="leadid"]').val()).indexOf("?")&&(t=t.replace("&","?")),a.modal("hide"));var i=$("#task-modal");i.is(":visible")&&i.modal("hide");var n=$("#_task_modal");n.is(":visible")&&n.modal("hide"),$.get(t,function(e){$("#_task").html(e),$("body").find("#_task_modal").modal({show:!0,backdrop:"static"})})}function showHideTagsPlaceholder(e){var t=e.data("ui-tagit").tagInput,a=e.data("ui-tagit").options.placeholderText;e.tagit("assignedTags").length>0?t.removeAttr("placeholder"):t.attr("placeholder",a)}function new_task_from_relation(e,t,a){void 0===t&&void 0===a&&(a=$(e).data("new-rel-id"),t=$(e).data("new-rel-type")),new_task(admin_url+"tasks/task?rel_id="+a+"&rel_type="+t)}function edit_task(e){$.get(admin_url+"tasks/task/"+e,function(e){$("#_task").html(e),$("#task-modal").modal("hide"),$("body").find("#_task_modal").modal({show:!0,backdrop:"static"})})}function task_form_handler(e){tinymce.triggerSave();var t=e.action,a=new FormData($(e)[0]);return $.ajax({type:$(e).attr("method"),data:a,mimeType:$(e).attr("enctype"),contentType:!1,cache:!1,processData:!1,url:t}).done(function(e){if(1==(e=JSON.parse(e)).success&&alert_float("success",e.message),$("body").hasClass("project")){var t=window.location.href,a=[];t=t.split("?");var i=get_url_param("group"),n=get_url_param("exclude_completed");i&&(a.group=i),n&&(a.exclude_completed=n),a.taskid=e.id,window.location.href=buildUrl(t[0],a)}else $("#_task_modal").attr("data-task-created",!0),$("#_task_modal").modal("hide"),init_task_modal(e.id),0==table_filters_applied&&reload_tasks_tables()}).fail(function(e){alert_float("danger",JSON.parse(e.responseText))}),!1}function timer_action(e,t,a){void 0===a&&(a=""),$(e).addClass("disabled");var i={};i.task_id=t,i.timer_id=a,i.note=$("body").find("#timesheet_note").val(),i.note||(i.note=""),$.post(admin_url+"tasks/timer_tracking",i).done(function(a){a=JSON.parse(a),$(e).removeClass("disabled"),$("#task-modal").is(":visible")&&init_task_modal(t),init_timers(),$(".popover-top-timer-note").popover("hide"),reload_tasks_tables()})}function init_task_modal(e){var t={taskid:e},a=$("#lead-modal"),i=$("#_task_modal");a.is(":visible")?(t.opened_from_lead_id=a.find('input[name="leadid"]').val(),a.modal("hide")):void 0!=i.attr("data-lead-id")&&(t.opened_from_lead_id=i.attr("data-lead-id")),$.post(admin_url+"tasks/get_task_data/",t).done(function(e){$("#task-modal .data").html(e),recalculate_checklist_items_progress(),setTimeout(function(){$("#task-modal").modal("show"),$("#task-modal").is(":visible")&&init_tags_inputs(),fix_task_modal_left_col_height()},150)}).fail(function(e){$("#task-modal").modal("hide"),alert_float("danger",e.responseText)})}function task_tracking_stats(e){$.get(admin_url+"tasks/task_tracking_stats/"+e,function(e){$("<div/>",{id:"tracking-stats"}).appendTo("body").html(e),$("#task-tracking-stats-modal").modal("toggle")})}function init_timers(){$.get(admin_url+"tasks/get_staff_started_timers",function(e){e.timers_found?$(".top-timers").addClass("text-success"):$(".top-timers").removeClass("text-success"),$(".started-timers-top").html(e.html)},"json")}function edit_task_comment(e){var t=$('[data-edit-comment="'+e+'"]');t.next().addClass("hide"),t.removeClass("hide"),tinymce.remove("#task_comment_"+e),init_editor("#task_comment_"+e,{height:150,auto_focus:!0}),tinymce.triggerSave()}function cancel_edit_comment(e){var t=$('[data-edit-comment="'+e+'"]');tinymce.remove('[data-edit-comment="'+e+'"] textarea'),t.addClass("hide"),t.next().removeClass("hide")}function save_edited_comment(e,t){tinymce.triggerSave();var a={};a.id=e,a.content=$('[data-edit-comment="'+e+'"]').find("textarea").val(),$.post(admin_url+"tasks/edit_comment",a).done(function(a){1==(a=JSON.parse(a)).success?(alert_float("success",a.message),init_task_modal(t)):cancel_edit_comment(e),tinymce.remove('[data-edit-comment="'+e+'"] textarea')})}function fix_task_modal_left_col_height(){if(!is_mobile()){var e=$("body").find(".task-single-col-left"),t=$("body").find(".task-single-col-right");e.css("min-height",t.outerHeight(!0)+"px")}}function tasks_kanban_update(e,t){if(t===e.item.parent()[0]){var a=$(e.item.parent()[0]).data("task-status-id"),i=$(e.item.parent()[0]).find("[data-task-id]"),n={};n.order=[];var o=0;$.each(i,function(){n.order.push([$(this).data("task-id"),o]),o++}),task_mark_as(a,$(e.item).data("task-id")),check_kanban_empty_col("[data-task-id]"),setTimeout(function(){$.post(admin_url+"tasks/update_order",n)},200)}}function tasks_kanban(){init_kanban("tasks",tasks_kanban_update,".tasks-status",280,360)}function edit_task_inline_description(e,t){tinyMCE.remove("#task_view_description"),$(e).hasClass("editor-initiated")?$(e).removeClass("editor-initiated"):($(e).addClass("editor-initiated"),$.Shortcuts.stop(),tinymce.init({selector:"#task_view_description",theme:"inlite",skin:"perfex",auto_focus:"task_view_description",plugins:"table link paste contextmenu textpattern",insert_toolbar:"quicktable",selection_toolbar:"bold italic | quicklink h2 h3 blockquote",inline:!0,table_default_styles:{width:"100%"},setup:function(e){e.on("blur",function(a){e.isDirty()&&$.post(admin_url+"tasks/update_task_description/"+t,{description:e.getContent()}),setTimeout(function(){e.remove(),$.Shortcuts.start()},500)})}}))}function tasks_bulk_action(e){if(0==confirm(appLang.confirm_action_prompt))return!1;var t=$("#mass_delete").prop("checked"),a=[],i={};if(0==t||void 0===t){i.status=$("#move_to_status_tasks_bulk_action").val(),i.priority=$("#task_bulk_priority").val(),i.assignees=$("#task_bulk_assignees").selectpicker("val"),i.milestone=$("#task_bulk_milestone").selectpicker("val");var n=$("#tags_bulk");if(n.length>0&&(i.tags=n.tagit("assignedTags")),void 0===i.priority&&(i.priority=""),void 0===i.tags&&(i.tags=""),""==i.status&&""==i.priority&&""==i.tags&&!i.assignees.length&&!i.milestone.length)return}else i.mass_delete=!0;var o=$($("#tasks_bulk_actions").attr("data-table")).find("tbody tr");$.each(o,function(){var e=$($(this).find("td").eq(0)).find("input");1==e.prop("checked")&&a.push(e.val())}),i.ids=a,$(e).addClass("disabled"),setTimeout(function(){$.post(admin_url+"tasks/bulk_action",i).done(function(){window.location.reload()})},200)}function init_invoice(e){var t=$('input[name="invoiceid"]').val();""==t||window.location.hash?window.location.hash&&!e&&(e=window.location.hash.substring(1)):(e=t,$('input[name="invoiceid"]').val("")),void 0!==e&&""!=e&&($("body").hasClass("small-table")||toggle_small_view(".table-invoices","#invoice"),$('input[name="invoiceid"]').val(e),do_hash_helper(e),$("#invoice").load(admin_url+"invoices/get_invoice_data_ajax/"+e),is_mobile()&&$("html, body").animate({scrollTop:$("#invoice").offset().top+150},600))}function init_estimate(e){var t=$('input[name="estimateid"]').val();""==t||window.location.hash?window.location.hash&&!e&&(e=window.location.hash.substring(1)):(e=t,$('input[name="estimateid"]').val("")),void 0!==e&&""!=e&&($("body").hasClass("small-table")||toggle_small_view(".table-estimates","#estimate"),$('input[name="estimateid"]').val(e),do_hash_helper(e),$("#estimate").load(admin_url+"estimates/get_estimate_data_ajax/"+e),is_mobile()&&$("html, body").animate({scrollTop:$("#estimate").offset().top+150},600))}function init_proposal(e){var t=$('input[name="proposal_id"]').val();""==t||window.location.hash?window.location.hash&&!e&&(e=window.location.hash.substring(1)):(e=t,$('input[name="proposal_id"]').val("")),void 0!==e&&""!=e&&($("body").hasClass("small-table")||toggle_small_view(".table-proposals","#proposal"),$('input[name="proposal_id"]').val(e),do_hash_helper(e),$("#proposal").load(admin_url+"proposals/get_proposal_data_ajax/"+e),is_mobile()&&$("html, body").animate({scrollTop:$("#proposal").offset().top+150},600))}function clear_billing_and_shipping_details(){for(var e in bs_fields)bs_fields[e].indexOf("country")>-1?$('select[name="'+bs_fields[e]+'"]').selectpicker("val",""):$('input[name="'+bs_fields[e]+'"]').val(""),"billing_country"==bs_fields[e]&&($('input[name="include_shipping"]').prop("checked",!1),$('input[name="include_shipping"]').change());init_billing_and_shipping_details()}function init_billing_and_shipping_details(){var e,t=$('input[name="include_shipping"]').prop("checked");for(var a in bs_fields)e="",e=bs_fields[a].indexOf("country")>-1?$("#"+bs_fields[a]+" option:selected").data("subtext"):$('input[name="'+bs_fields[a]+'"]').val(),bs_fields[a].indexOf("shipping")>-1&&(t||(e="")),void 0===e&&(e=""),e=""!=e?e:"--",$("."+bs_fields[a]).text(e);$("#billing_and_shipping_details").modal("hide")}function record_payment(e){void 0!==e&&""!=e&&$("#invoice").load(admin_url+"invoices/record_invoice_payment_ajax/"+e)}function add_item_to_preview(e){$.get(admin_url+"invoice_items/get_item_by_id/"+e,function(e){$('.main textarea[name="description"]').val(e.description),$('.main textarea[name="long_description"]').val(e.long_description.replace(/(<|&lt;)br\s*\/*(>|&gt;)/g," ")),$('.main input[name="quantity"]').val(1);var t=[];e.taxname&&e.taxrate&&t.push(e.taxname+"|"+e.taxrate),e.taxname_2&&e.taxrate_2&&t.push(e.taxname_2+"|"+e.taxrate_2),$(".main select.tax").selectpicker("val",t),$('.main input[name="unit"]').val(e.unit);var a=$("body").find('.accounting-template select[name="currency"]'),i=a.attr("data-base"),n=a.find("option:selected").val(),o=$('.main input[name="rate"]');if(i==n)o.val(e.rate);else{var s=e["rate_currency_"+n];s&&0!==parseFloat(s)?o.val(s):o.val(e.rate)}$(document).trigger({type:"item-added-to-preview",item:e,item_type:"item"})},"json")}function add_task_to_preview_as_item(e){$.get(admin_url+"tasks/get_billable_task_data/"+e,function(t){t.taxname=$("select.main-tax").selectpicker("val"),$('.main textarea[name="description"]').val(t.name),$('.main textarea[name="long_description"]').val(t.description),$('.main input[name="quantity"]').val(t.total_hours),$('.main input[name="rate"]').val(t.hourly_rate),$('.main input[name="unit"]').val(""),$('input[name="task_id"]').val(e),$(document).trigger({type:"item-added-to-preview",item:t,item_type:"task"})},"json")}function clear_main_values(e){var t=$("table.items tbody").find("tr:last-child").find("select").selectpicker("val");$('.main textarea[name="description"]').val(""),$('.main textarea[name="long_description"]').val(""),$('.main input[name="quantity"]').val(1),$(".main select.tax").selectpicker("val",t),$('.main input[name="rate"]').val(""),$('.main input[name="unit"]').val(""),$('input[name="task_id"]').val(""),$('input[name="expense_id"]').val("")}function add_item_to_table(e,t,a,i){if(void 0!==e&&"undefined"!=e||(e=get_main_values()),""!==e.description||""!==e.long_description||""!==e.rate){var n="",o="",s=$("body").find("tbody .item").length+1;n+='<tr class="sortable item" data-merge-invoice="'+a+'" data-bill-expense="'+i+'">',n+='<td class="dragger">',isNaN(e.qty)&&(e.qty=1),(""==e.rate||isNaN(e.rate))&&(e.rate=0);var l=e.rate*e.qty;l=accounting.formatNumber(l);var d="newitems["+s+"][taxname][]";$("body").append('<div class="dt-loader"></div>');var r=/<br[^>]*>/gi;return get_taxes_dropdown_template(d,e.taxname).done(function(a){n+='<input type="hidden" class="order" name="newitems['+s+'][order]">',n+="</td>",n+='<td class="bold description"><textarea name="newitems['+s+'][description]" class="form-control" rows="5">'+e.description+"</textarea></td>",n+='<td><textarea name="newitems['+s+'][long_description]" class="form-control item_long_description" rows="5">'+e.long_description.replace(r,"\n")+"</textarea></td>",n+='<td><input type="number" min="0" onblur="calculate_total();" onchange="calculate_total();" data-quantity name="newitems['+s+'][qty]" value="'+e.qty+'" class="form-control">',o="",e.unit&&void 0!==e.unit||(o=appLang.unit,e.unit=""),n+='<input type="text" placeholder="'+o+'" name="newitems['+s+'][unit]" class="form-control input-transparent text-right" value="'+e.unit+'">',n+="</td>",n+='<td class="rate"><input type="number" data-toggle="tooltip" title="'+appLang.item_field_not_formatted+'" onblur="calculate_total();" onchange="calculate_total();" name="newitems['+s+'][rate]" value="'+e.rate+'" class="form-control"></td>',n+='<td class="taxrate">'+a+"</td>",n+='<td class="amount">'+l+"</td>",n+='<td><a href="#" class="btn btn-danger pull-left" onclick="delete_item(this,'+t+'); return false;"><i class="fa fa-trash"></i></a></td>',n+="</tr>",$("table.items tbody").append(n),$(document).trigger({type:"item-added-to-table",data:e,row:n}),setTimeout(function(){calculate_total()},15);var i=$('input[name="task_id"]').val(),d=$('input[name="expense_id"]').val();return""!=i&&void 0!==i&&(billed_tasks=i.split(","),$.each(billed_tasks,function(e,t){$("#billed-tasks").append(hidden_input("billed_tasks["+s+"][]",t))})),""!=d&&void 0!==d&&(billed_expenses=d.split(","),$.each(billed_expenses,function(e,t){$("#billed-expenses").append(hidden_input("billed_expenses["+s+"][]",t))})),init_selectpicker(),clear_main_values(),reorder_items(),$("body").find(".dt-loader").remove(),$("#item_select").selectpicker("val",""),!0}),!1}}function get_taxes_dropdown_template(e,t){jQuery.ajaxSetup({async:!1});var a=$.post(admin_url+"misc/get_taxes_dropdown_template/",{name:e,taxname:t});return jQuery.ajaxSetup({async:!0}),a}function deselect_ajax_search(e){var t=$("select#"+$(e).attr("data-id"));t.data("AjaxBootstrapSelect").list.cache={};var a=t.parents(".bootstrap-select");t.html("").append('<option value=""></option>').selectpicker("val",""),a.removeClass("ajax-remove-values-option").find(".ajax-clear-values").remove(),setTimeout(function(){t.trigger("selected.cleared.ajax.bootstrap.select",e),t.trigger("change").data("AjaxBootstrapSelect").list.cache={}},50)}function init_ajax_project_search_by_customer_id(e){void 0===e&&(e="#project_id.ajax-search"),init_ajax_search("project",e,{customer_id:function(){return $('select[name="clientid"]').val()}})}function init_ajax_projects_search(e){void 0===e&&(e="#project_id.ajax-search"),init_ajax_search("project",e)}function fixHelperTableHelperSortable(e,t){return t.children().each(function(){$(this).width($(this).width())}),t}function init_items_sortable(e){var t=$("body").find(".items tbody");0!=t.length&&t.sortable({helper:fixHelperTableHelperSortable,handle:".dragger",placeholder:"ui-placeholder",itemPath:"> tbody",itemSelector:"tr.sortable",items:"tr.sortable",update:function(){void 0===e?reorder_items():save_ei_items_order()},sort:function(e,t){var a=$(e.target);if(!/html|body/i.test(a.offsetParent()[0].tagName)){var i=e.pageY-a.offsetParent().offset().top-t.helper.outerHeight(!0)/2;t.helper.css({top:i+"px"})}}})}function save_ei_items_order(){var e,t=$(".table.invoice-items-preview.items tbody tr,.table.estimate-items-preview.items tbody tr"),a=1,i=[];if($(".table.items").hasClass("invoice-items-preview"))e="invoice";else{if(!$(".table.items").hasClass("estimate-items-preview"))return!1;e="estimate"}$.each(t,function(){i.push([$(this).data("item-id"),a]),$(this).find("td.item_no").html(a),a++}),setTimeout(function(){$.post(admin_url+"misc/update_ei_items_order/"+e,{data:i})},200)}function reorder_items(){var e=$(".table.table-main-invoice-edit tbody tr.item,.table.table-main-estimate-edit tbody tr.item"),t=1;$.each(e,function(){$(this).find("input.order").val(t),t++})}function get_main_values(){var e={};return e.description=$('.main textarea[name="description"]').val(),e.long_description=$('.main textarea[name="long_description"]').val(),e.qty=$('.main input[name="quantity"]').val(),e.taxname=$(".main select.tax").selectpicker("val"),e.rate=$('.main input[name="rate"]').val(),e.unit=$('.main input[name="unit"]').val(),e}function calculate_total(){var e,t,a,i,n,o,s={},l=0,d=0,r=1;total_discount_calculated=0,rows=$(".table.table-main-invoice-edit tbody tr.item,.table.table-main-estimate-edit tbody tr.item"),adjustment=$('input[name="adjustment"]').val(),discount_area=$("tr#discount_percent"),discount_percent=$('input[name="discount_percent"]').val(),discount_type=$('select[name="discount_type"]').val(),$(".tax-area").remove(),$.each(rows,function(){""==(r=$(this).find("[data-quantity]").val())&&(r=1,$(this).find("[data-quantity]").val(1)),n=parseFloat($(this).find("td.rate input").val())*r,$(this).find("td.amount").html(accounting.formatNumber(n)),l+=n,i=$(this),(a=$(this).find("select.tax").selectpicker("val"))&&$.each(a,function(a,l){t=i.find('select.tax [value="'+l+'"]').data("taxrate"),e=n/100*t,s.hasOwnProperty(l)?s[l]=s[l]+=e:0!=t&&(o=l.split("|"),tax_row='<tr class="tax-area"><td>'+o[0]+"("+t+'%)</td><td id="tax_id_'+slugify(l)+'"></td></tr>',$(discount_area).after(tax_row),s[l]=e)})}),""!=discount_percent&&"before_tax"==discount_type&&(total_discount_calculated=l*discount_percent/100),$.each(s,function(e,t){""!=discount_percent&&"before_tax"==discount_type&&(total_tax_calculated=t*discount_percent/100,t-=total_tax_calculated),d+=t,t=accounting.formatNumber(t),$("#tax_id_"+slugify(e)).html(t)}),d+=l,""!=discount_percent&&"after_tax"==discount_type&&(total_discount_calculated=d*discount_percent/100),d-=total_discount_calculated,adjustment=parseFloat(adjustment),isNaN(adjustment)||(d+=adjustment),$(".discount_percent").html("-"+accounting.formatNumber(total_discount_calculated)+hidden_input("discount_percent",discount_percent)+hidden_input("discount_total",total_discount_calculated)),$(".adjustment").html(accounting.formatNumber(adjustment)+hidden_input("adjustment",accounting.toFixed(adjustment,app_decimal_places))),$(".subtotal").html(accounting.formatNumber(l)+hidden_input("subtotal",accounting.toFixed(l,app_decimal_places))),$(".total").html(format_money(d)+hidden_input("total",accounting.toFixed(d,app_decimal_places))),$(document).trigger("sales-total-calculated")}function delete_item(e,t){$(e).parents("tr").addClass("animated fadeOut",function(){setTimeout(function(){$(e).parents("tr").remove(),calculate_total()},50)}),$('input[name="isedit"]').length>0&&$("#removed-items").append(hidden_input("removed_items[]",t))}function format_money(e){return"after"===app_currency_placement?accounting.formatMoney(e,{format:"%v %s"}):accounting.formatMoney(e)}function init_currency_symbol(){"undefined"!=typeof accounting&&(accounting.settings.currency.symbol=$("body").find('.accounting-template select[name="currency"]').find("option:selected").data("subtext"),calculate_total())}function delete_invoice_attachment(e){if(0==confirm(appLang.confirm_action_prompt))return!1;$.get(admin_url+"invoices/delete_attachment/"+e,function(t){1==t&&($("body").find('[data-attachment-id="'+e+'"]').remove(),init_invoice($("body").find('input[name="_attachment_sale_id"]').val()))}).fail(function(e){alert_float("danger",e.responseText)})}function delete_estimate_attachment(e){if(0==confirm(appLang.confirm_action_prompt))return!1;$.get(admin_url+"estimates/delete_attachment/"+e,function(t){if(1==t){$("body").find('[data-attachment-id="'+e+'"]').remove();var a=$("body").find('input[name="_attachment_sale_id"]').val();$("body").hasClass("estimates-pipeline")?estimate_pipeline_open(a):init_estimate(a)}}).fail(function(e){alert_float("danger",e.responseText)})}function delete_proposal_attachment(e){if(0==confirm(appLang.confirm_action_prompt))return!1;$.get(admin_url+"proposals/delete_attachment/"+e,function(t){if(1==t){var a=$("body").find('input[name="_attachment_sale_id"]').val();$("body").find('[data-attachment-id="'+e+'"]').remove(),$("body").hasClass("proposals-pipeline")?proposal_pipeline_open(a):init_proposal(a)}}).fail(function(e){alert_float("danger",e.responseText)})}function init_invoices_total(e){if(0!=$("#invoices_total").length){var t=$(".invoices-total-inline"),a=$(".invoices-total");if(!$("body").hasClass("invoices_total_manual")||void 0!==e||a.hasClass("initialized"))if(t.length>0&&a.hasClass("initialized"))t.removeClass("invoices-total-inline");else{a.addClass("initialized");var i=$("body").find('select[name="invoices_total_years"]').selectpicker("val"),n=[];$.each(i,function(e,t){""!=t&&n.push(t)});var o={currency:$("body").find('select[name="total_currency"]').val(),years:n,init_total:!0},s=$('input[name="project_id"]').val(),l=$('.customer_profile input[name="userid"]').val();void 0!==s?o.project_id=s:void 0!==l&&(o.customer_id=l),$.post(admin_url+"invoices/get_invoices_total",o).done(function(e){$("#invoices_total").html(e)})}}}function init_estimates_total(e){if(0!=$("#estimates_total").length){var t=$(".estimates-total");if(!$("body").hasClass("estimates_total_manual")||void 0!==e||t.hasClass("initialized")){t.addClass("initialized");var a=$("body").find('select[name="total_currency"]').val(),i=$("body").find('select[name="estimates_total_years"]').selectpicker("val"),n=[];$.each(i,function(e,t){""!=t&&n.push(t)});var o="",s="",l=$('.customer_profile input[name="userid"]').val(),d=$('input[name="project_id"]').val();void 0!==l?o=l:void 0!==d&&(s=d),$.post(admin_url+"estimates/get_estimates_total",{currency:a,init_total:!0,years:n,customer_id:o,project_id:s}).done(function(e){$("#estimates_total").html(e)})}}}function init_expenses_total(){if(0!=$("#expenses_total").length){var e=$("body").find('select[name="expenses_total_currency"]').val(),t=$("body").find('select[name="expenses_total_years"]').selectpicker("val"),a=[];$.each(t,function(e,t){""!=t&&a.push(t)});var i="",n=$('.customer_profile input[name="userid"]').val();void 0!==i&&(i=n);var o="",s=$('input[name="project_id"]').val();void 0!==o&&(o=s),$.post(admin_url+"expenses/get_expenses_total",{currency:e,init_total:!0,years:a,customer_id:i,project_id:o}).done(function(e){$("#expenses_total").html(e)})}}function validate_invoice_form(e){void 0===e&&(e="#invoice-form"),_validate_form($(e),{clientid:"required",date:"required",currency:"required",number:{required:!0}}),$("body").find('input[name="number"]').rules("add",{remote:{url:admin_url+"invoices/validate_invoice_number",type:"post",data:{number:function(){return $('input[name="number"]').val()},isedit:function(){return $('input[name="number"]').data("isedit")},original_number:function(){return $('input[name="number"]').data("original-number")},date:function(){return $('input[name="date"]').val()}}},messages:{remote:appLang.invoice_number_exists}})}function validate_estimate_form(e){void 0===e&&(e="#estimate-form"),_validate_form($(e),{clientid:"required",date:"required",currency:"required",number:{required:!0}}),$("body").find('input[name="number"]').rules("add",{remote:{url:admin_url+"estimates/validate_estimate_number",type:"post",data:{number:function(){return $('input[name="number"]').val()},isedit:function(){return $('input[name="number"]').data("isedit")},original_number:function(){return $('input[name="number"]').data("original-number")},date:function(){return $('input[name="date"]').val()}}},messages:{remote:appLang.estimate_number_exists}})}function estimates_pipeline_sort(e){var t=$('input[name="sort"]');$('input[name="sort_type"]').val(e),"ASC"==t.val()?t.val("DESC"):"DESC"==t.val()?t.val("ASC"):t.val("DESC"),estimate_pipeline()}function proposal_pipeline_sort(e){var t=$('input[name="sort"]');$('input[name="sort_type"]').val(e),"ASC"==t.val()?t.val("DESC"):"DESC"==t.val()?t.val("ASC"):t.val("DESC"),proposals_pipeline()}function estimate_pipeline(){init_kanban("estimates/get_pipeline",estimates_pipeline_update,".pipeline-status",360,360)}function estimates_pipeline_update(e,t){if(t===e.item.parent()[0]){var a={};a.estimateid=$(e.item).data("estimate-id"),a.status=$(e.item.parent()[0]).data("status-id");var i=[],n=$(e.item).parents(".pipeline-status").find("li"),o=1;$.each(n,function(){i.push([$(this).data("estimate-id"),o]),o++}),a.order=i,check_kanban_empty_col("[data-estimate-id]"),$.post(admin_url+"estimates/update_pipeline",a)}}function proposals_pipeline_update(e,t){if(t===e.item.parent()[0]){var a={};a.proposalid=$(e.item).data("proposal-id"),a.status=$(e.item.parent()[0]).data("status-id");var i=[],n=$(e.item).parents(".pipeline-status").find("li"),o=1;$.each(n,function(){i.push([$(this).data("proposal-id"),o]),o++}),a.order=i,check_kanban_empty_col("[data-proposal-id]"),$.post(admin_url+"proposals/update_pipeline",a)}}function proposals_pipeline(){init_kanban("proposals/get_pipeline",proposals_pipeline_update,".pipeline-status",360,360)}function proposal_pipeline_open(e){""!=e&&$.get(admin_url+"proposals/pipeline_open/"+e,function(e){var t=$(".proposal-pipeline-modal:visible").length;$("#proposal").html(e),0==t?$(".proposal-pipeline-modal").modal({show:!0,backdrop:"static",keyboard:!1}):$("#proposal").find(".modal.proposal-pipeline-modal").addClass("in").css("display","block")})}function estimate_pipeline_open(e){""!=e&&$.get(admin_url+"estimates/pipeline_open/"+e,function(e){var t=$(".estimate-pipeline:visible").length;$("#estimate").html(e),0==t?$(".estimate-pipeline").modal({show:!0,backdrop:"static",keyboard:!1}):$("#estimate").find(".modal.estimate-pipeline").addClass("in").css("display","block")})}function delete_estimate_note(e,t){if(0==confirm(appLang.confirm_action_prompt))return!1;$.get(admin_url+"estimates/delete_note/"+t,function(t){1==t.success&&$(e).parents(".estimate-note").remove()},"json")}function get_estimate_notes(e){$.get(admin_url+"estimates/get_notes/"+e,function(e){$("#estimate_notes_area").html(e)})}function insert_proposal_merge_field(e){var t=$(e).text();tinymce.activeEditor.execCommand("mceInsertContent",!1,t)}function small_table_full_view(){$("#small-table").toggleClass("hide"),$(".small-table-right-col").toggleClass("col-md-12 col-md-7")}function manage_invoice_items(e){var t=$(e).serialize(),a=e.action;return $.post(a,t).done(function(e){if(1==(e=JSON.parse(e)).success){var t=$("#item_select");if($("body").find(".accounting-template").length>0){var a=t.find('[data-group-id="'+e.item.group_id+'"]'),i='<option data-subtext="'+e.item.long_description+'" value="'+e.item.itemid+'">('+accounting.formatNumber(e.item.rate)+") "+e.item.description+"</option>";if(t.hasClass("ajax-search")||(0==a.length?(i='<optgroup label="'+(null==e.item.group_name?"":e.item.group_name)+'" data-group-id="'+e.item.group_id+'">'+i+"</optgroup>",0==t.find('[data-group-id="0"]').length?t.find("option:first-child").after(i):t.find('[data-group-id="0"]').after(i)):a.prepend(i)),t.hasClass("ajax-search")){t.contents().filter(function(){return!$(this).is(".newitem")&&$(this).is(".newitem-divider")}).remove();var n=t.clone();t.selectpicker("destroy").remove(),t=n,$("body").find(".items-wrapper").append(n),init_ajax_search("items","#item_select.ajax-search",void 0,admin_url+"items/search")}else t.selectpicker("refresh");add_item_to_preview(e.item.itemid)}else $(".table-invoice-items").DataTable().ajax.reload(null,!1);alert_float("success",e.message)}$("#sales_item_modal").modal("hide")}).fail(function(e){alert_float("danger",e.responseText)}),!1}function save_sales_number_settings(e){var t={};t.prefix=$("body").find('input[name="s_prefix"]').val(),""!=t.prefix&&$.post($(e).data("url"),t).done(function(e){(e=JSON.parse(e)).success&&e.message&&(alert_float("success",e.message),$("#prefix").html(t.prefix))})}function do_prefix_year(e){var t;e.indexOf(".")>-1?t=e.split("."):e.indexOf("-")>-1?t=e.split("-"):e.indexOf("/")>-1&&(t=e.split("/")),void 0!==t&&$.each(t,function(e,t){4==t.length&&$("#prefix_year").html(t)})}function vault_re_enter_password(e,t){var a=$(t),i=$("#vaultEntry-"+e),n=$("#vaultConfirmPassword");_validate_form(n.find("form"),{user_password:"required"},vault_encrypt_password),a.hasClass("decrypted")?(a.removeClass("decrypted"),i.find(".vault-password-fake").removeClass("hide"),i.find(".vault-password-encrypted").addClass("hide")):(n.find('form input[name="id"]').val(e),n.modal("show"))}function vault_encrypt_password(e){var t=$(e),a=$("#vaultEntry-"+t.find('input[name="id"]').val()),i=t.serialize(),n=$("#vaultConfirmPassword");return $.post(t.attr("action"),i).done(function(e){e=JSON.parse(e),a.find(".vault-password-fake").addClass("hide"),a.find(".vault-view-password").addClass("decrypted"),a.find(".vault-password-encrypted").removeClass("hide").html(e.password),n.modal("hide"),n.find('input[name="user_password"]').val("")}).fail(function(e){alert_float("danger",JSON.parse(e.responseText).error_msg)}),!1}function set_notification_read_inline(e){$.get(admin_url+"misc/set_notification_read_inline/"+e,function(){var t=$("body").find('.notification-wrapper[data-notification-id="'+e+'"]');t.find(".notification-box,.notification-box-all").removeClass("unread"),t.find(".not-mark-as-read-inline").tooltip("destroy").remove()})}function mark_all_notifications_as_read_inline(){$.get(admin_url+"misc/mark_all_notifications_as_read_inline/",function(){var e=$("body").find(".notification-wrapper");e.find(".notification-box,.notification-box-all").removeClass("unread"),e.find(".not-mark-as-read-inline").tooltip("destroy").remove()})}function delete_sale_activity(e){if(0==confirm(appLang.confirm_action_prompt))return!1;$.get(admin_url+"misc/delete_sale_activity/"+e,function(){$("body").find('[data-sale-activity-id="'+e+'"]').remove()})}function view_event(e){void 0!==e&&$.post(admin_url+"utilities/view_event/"+e).done(function(e){$("#event").html(e),$("#viewEvent").modal("show"),init_datepicker(),init_selectpicker(),validate_calendar_form()})}function delete_event(e){$.get(admin_url+"utilities/delete_event/"+e,function(e){window.location.reload()},"json")}function validate_calendar_form(){_validate_form($("body").find("._event form"),{title:"required",start:"required",reminder_before:"required"},calendar_form_handler),_validate_form($("body").find("#viewEvent form"),{title:"required",start:"required",reminder_before:"required"},calendar_form_handler)}function calendar_form_handler(e){return $.post(e.action,$(e).serialize()).done(function(e){1==(e=JSON.parse(e)).success&&(alert_float("success",e.message),setTimeout(function(){var e=window.location.href;e=e.split("?"),window.location.href=e[0]},500))}),!1}function add_hotkey(e,t){$.Shortcuts.add({type:"down",mask:e,handler:t})}function fetch_notifications(e){$.get(admin_url+"misc/notifications_check",function(e){var t=notifications_wrapper;t.html(e.html);var a=t.find("ul.notifications").attr("data-total-unread");document.title=a>0?"("+a+") "+doc_initial_title:doc_initial_title,setTimeout(function(){var a=e.notificationsIds;a.length>0&&$.each(a,function(e,a){var i='li[data-notification-id="'+a+'"]',n=t.find(i);$.notify("",{title:appLang.new_notification,body:n.find(".notification-title").text(),requireInteraction:!0,icon:n.find(".notification-image").attr("src"),tag:a}).close(function(){$.get(admin_url+"misc/set_desktop_notification_read/"+a,function(){var e=t.find(".icon-total-indicator");t.find('li[data-notification-id="'+a+'"] .notification-box').removeClass("unread");var i=e.text();i=i.trim(),(i-=1)>0?(document.title="("+i+") "+doc_initial_title,e.html(i)):(document.title=doc_initial_title,e.addClass("hide"))})}).click(function(e){parent.focus(),window.focus(),setTimeout(function(){t.find(i+" .notification-link").addClass("desktopClick").click(),e.target.close()},70)})})},200)},"json")}function merge_field_format_url(e,t,a,i){return e.indexOf("{")>-1&&e.indexOf("}")>-1&&(e="{"+e.split("{")[1]),e}function slugify(e){return e.toString().trim().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}$(window).on("load",function(){init_btn_with_tooltips()}),$.fn.dataTable.ext.errMode="throw",$.fn.dataTableExt.oStdClasses.sWrapper="dataTables_wrapper form-inline dt-bootstrap table-loading",Dropzone.options.newsFeedDropzone=!1,Dropzone.options.salesUpload=!1,"Notification"in window&&"1"==app_desktop_notifications&&Notification.requestPermission(),$.validator.setDefaults({highlight:function(e){$(e).closest(".form-group").addClass("has-error")},unhighlight:function(e){$(e).closest(".form-group").removeClass("has-error")},errorElement:"p",errorClass:"text-danger",errorPlacement:function(e,t){t.parent(".input-group").length||t.parents(".chk").length?t.parents(".chk").length?e.insertAfter(t.parents(".chk")):e.insertAfter(t.parent()):e.insertAfter(t)}}),$.validator.addMethod("filesize",function(e,t,a){return this.optional(t)||t.files[0].size<=a},appLang.file_exceeds_max_filesize),$.validator.addMethod("extension",function(e,t,a){return a="string"==typeof a?a.replace(/,/g,"|"):"png|jpe?g|gif",this.optional(t)||e.match(new RegExp("\\.("+a+")$","i"))},$.validator.format(appLang.validation_extension_not_allowed)),$("body").on("loaded.bs.select change","select.ajax-search",function(e){if($(this).selectpicker("val")){var t=$(this).parents(".bootstrap-select.ajax-search");0===t.find(".ajax-clear-values").length&&t.addClass("ajax-remove-values-option").find("button.dropdown-toggle").after('<span class="pointer ajax-clear-values" onclick="deselect_ajax_search(this); return false;" data-id="'+$(this).attr("id")+'"><i class="fa fa-remove"></i></span>')}});var delay=function(){var e=0;return function(t,a){clearTimeout(e),e=setTimeout(t,a)}}(),original_top_search_val,tab_active=get_url_param("tab"),tab_group=get_url_param("group"),side_bar=$("#side-menu"),content_wrapper=$("#wrapper"),setup_menu=$("#setup-menu-wrapper"),menu_href_selector,calendar_selector=$("#calendar"),notifications_wrapper=$("#header li.notifications-wrapper"),doc_initial_title=document.title,table_filters_applied=!1,total_new_post_files=0,newsfeed_posts_page=0,track_load_post_likes=0,track_load_comment_likes=0,post_likes_total_pages=0,comment_likes_total_pages=0,postid=0,available_reminders_table=[".table-reminders",".table-invoices",".table-reminders-leads",".table-invoices",".table-estimates",".table-proposals",".table-expenses",".table-my-reminders"],setup_menu_item=$("#setup-menu-item");$(window).on("load resize",function(e){$("body").hasClass("page-small")||setBodySmall(),setTimeout(function(){mainWrapperHeightFix()},150)}),$(function(){total_unread_notifications>0&&(document.title="("+total_unread_notifications+") "+doc_initial_title),add_hotkey("Shift+C",function(){var e=$("#lead-modal"),t=$("#task-modal");if(e.is(":visible"))convert_lead_to_customer(e.find('input[name="leadid"]').val());else if(t.is(":visible")){var a=t.find(".tasks-comments");a.is(":visible")||a.css("display","block"),t.find("#task_comment").click()}else window.location.href=admin_url+"clients/client"}),add_hotkey("Shift+I",function(){window.location.href=admin_url+"invoices/invoice"}),add_hotkey("Shift+E",function(){var e=$("#lead-modal"),t=$("#task-modal");e.is(":visible")||t.is(":visible")?e.is(":visible")?$("a[lead-edit]").click():t.is(":visible")&&edit_task(t.find("[data-task-single-id]").attr("data-task-single-id")):window.location.href=admin_url+"estimates/estimate"}),add_hotkey("Shift+F",function(){var e=$("#task-modal");if(e.is(":visible")){var t=e.find("[data-task-single-id]");5!=t.attr("data-status")&&mark_complete(t.attr("data-task-single-id"))}}),add_hotkey("Ctrl+Shift+P",function(){window.location.href=admin_url+"proposals/proposal"}),add_hotkey("Ctrl+Shift+E",function(){window.location.href=admin_url+"expenses/expense"}),add_hotkey("Shift+L",function(){init_lead()}),add_hotkey("Shift+T",function(){var e=$(".new-task-relation");e.length>0?new_task(admin_url+"tasks/task?rel_id="+e.attr("data-rel-id")+"&rel_type="+e.attr("data-rel-type")):$("body").hasClass("project")?new_task(admin_url+"tasks/task?rel_id="+project_id+"&rel_type=project"):new_task()}),add_hotkey("Shift+P",function(){window.location.href=admin_url+"projects/project"}),add_hotkey("Shift+S",function(){window.location.href=admin_url+"tickets/add"}),add_hotkey("Ctrl+Shift+S",function(){window.location.href=admin_url+"staff/member"}),add_hotkey("Ctrl+Shift+L",function(){logout()}),add_hotkey("Alt+D",function(){window.location.href=admin_url}),add_hotkey("Alt+C",function(){window.location.href=admin_url+"clients"}),add_hotkey("Alt+T",function(){window.location.href=admin_url+"tasks/list_tasks"}),add_hotkey("Alt+I",function(){window.location.href=admin_url+"invoices/list_invoices"}),add_hotkey("Alt+E",function(){window.location.href=admin_url+"estimates/list_estimates"}),add_hotkey("Alt+P",function(){window.location.href=admin_url+"projects"}),add_hotkey("Alt+L",function(){window.location.href=admin_url+"leads"}),add_hotkey("Ctrl+Alt+T",function(){window.location.href=admin_url+"tickets"}),add_hotkey("Ctrl+Alt+E",function(){window.location.href=admin_url+"expenses/list_expenses"}),add_hotkey("Alt+R",function(){window.location.href=admin_url+"reports/sales"}),add_hotkey("Alt+S",function(){window.location.href=admin_url+"settings"}),add_hotkey("Shift+K",function(){$("#search_input").focus()}),add_hotkey("Shift+D",function(){$("body .dataTables_wrapper").eq(0).find(".dataTables_filter input").focus()}),$.Shortcuts.start(),$(document).on("focusin",function(e){$(e.target).closest(".mce-window").length&&e.stopImmediatePropagation()}),1!=app_show_setup_menu_item_only_on_hover||is_mobile()||side_bar.hover(function(){setTimeout(function(){setup_menu_item.css("display","block")},200)},function(){setTimeout(function(){setup_menu_item.css("display","none")},1e3)});var e=$("body").find("ul.nav-tabs");tab_active&&e.find('[href="#'+tab_active+'"]').click(),tab_group&&(e.find("li").not('[role="presentation"]').removeClass("active"),e.find('[data-group="'+tab_group+'"]').parents("li").addClass("active")),jQuery.datetimepicker.setLocale(locale),moment.locale(locale),moment().tz(app_timezone).format(),init_editor(),$("body").on("click","#started-timers-top,.popover-top-timer-note",function(e){e.stopPropagation()}),init_tags_inputs(),init_color_pickers(),initDataTableOffline(),$("body").on("change",".onoffswitch input",function(e,t){$(this).data("switch-url")&&switch_field(this)}),custom_fields_hyperlink(),init_lightbox(),init_progress_bars(),init_datepicker(),init_selectpicker(),setBodySmall(),init_form_reminder(),init_ajax_search("customer","#clientid.ajax-search");var t=side_bar.find("li > a");if($.each(t,function(e,t){var a=$(t).attr("href");if(location==a){var i=side_bar.find('a[href="'+a+'"]');i.parents("li").not(".quick-links").addClass("active"),i.prop("aria-expanded",!0),i.parents("ul.nav-second-level").prop("aria-expanded",!0),i.parents("li").find("a:first-child").prop("aria-expanded",!0)}}),setup_menu.hasClass("display-block")){var a=setup_menu.find("li > a");$.each(a,function(e,t){var a=$(t).attr("href");if(location==a){var i=setup_menu.find('a[href="'+a+'"]');i.parents("li").addClass("active"),i.prev("active"),i.parents("ul.nav-second-level").prop("aria-expanded",!0),i.parents("li").find("a:first-child").prop("aria-expanded",!0)}})}if(side_bar.metisMenu(),setup_menu.metisMenu(),$(".hide-menu").click(function(e){e.preventDefault(),$(window).width()<769?$("body").toggleClass("show-sidebar"):$("body").toggleClass("hide-sidebar"),setup_menu.hasClass("display-block")&&$(".close-customizer").click()}),is_mobile()&&content_wrapper.on("click",function(){$("body").hasClass("show-sidebar")&&$("body").removeClass("show-sidebar"),setup_menu.hasClass("display-block")&&$(".close-customizer").click()}),mainWrapperHeightFix(),$("#search_input").on("keyup paste",function(){var e=$(this).val().trim(),t=$("#search_results"),a=$("#top_search_button button");if(!(e.length<2)){if(""===e)return content_wrapper.unhighlight(),t.html(""),original_top_search_val="",a.html('<i class="fa fa-search"></i>'),void a.removeClass("search_remove");a.html('<i class="fa fa-remove"></i>'),a.addClass("search_remove"),delay(function(){e!=original_top_search_val&&$.post(admin_url+"misc/search",{q:e}).done(function(a){content_wrapper.unhighlight(),t.html(a),content_wrapper.highlight(e),original_top_search_val=e})},700)}}),$("body").on("click",".delete-reminder",function(){return!1!==confirm(appLang.confirm_action_prompt)&&($.get($(this).attr("href"),function(e){alert_float(e.alert_type,e.message),reload_reminders_tables()},"json"),!1)}),$("body").on("keypress",'textarea[name="checklist-description"]',function(e){if("13"==e.which)return $(this).focusout(),add_task_checklist_item($(this).attr("data-taskid")),!1}),$("body").on("blur",'textarea[name="checklist-description"]',function(){var e=$(this),t=e.val();t=t.trim();var a=e.parents(".checklist").data("checklist-id");$.post(admin_url+"tasks/update_checklist_item",{description:t,listid:a}).done(function(i){!0===(i=JSON.parse(i)).can_be_template&&e.parents(".checklist").find(".save-checklist-template").removeClass("hide"),""===t&&$("#checklist-items").find('.checklist[data-checklist-id="'+a+'"]').remove()})}),$("body").on("rendered.bs.select,refreshed.bs.select","select.checklist-items-template-select",function(){"1"==has_permission_tasks_checklist_items_delete&&setTimeout(function(){var e=$("body").find(".checklist-items-template-select ul.dropdown-menu li").not(":first-child"),t=$("body").find(".checklist-items-template-select select option").not(":first-child");$.each(t,function(t,a){var i=$(a);0==$(e[t]).find(".checklist-item-template-remove").length&&$(e[t]).find("a > span.text").after('<small class="checklist-item-template-remove" onclick="remove_checklist_item_template('+i.attr("value")+'); event.stopPropagation();"><i class="fa fa-remove"></i></small>')})},100)}),$("body").on("change","#task-modal #checklist_items_templates",function(){var e=$(this).val();add_task_checklist_item($("#task-modal").find("[data-task-single-id]").attr("data-task-single-id"),$(this).find('option[value="'+e+'"]').html().trim()),$(this).selectpicker("val","")}),$("body").on("click",".task-date-as-comment-id",function(e){e.preventDefault();var t=$(this).attr("href").split("#"),a=$("#"+t[t.length-1]).position();$("#task-modal").scrollTop(a.top)}),$("body").on("click","table.dataTable tbody .tags-labels .label-tag",function(){$(this).parents("table").DataTable().search($(this).find(".tag").text()).draw(),$("div.dataTables_filter input").focus()}),$("body").on("click","table.dataTable tbody .customer-group-list",function(){$(this).parents("table").DataTable().search($(this).text()).draw(),$("div.dataTables_filter input").focus()}),$("body").on("click","table.dataTable tbody .lead-status",function(){var e=$.trim($(this).text()),t=$("#view_status");t.find("option").filter(function(){return this.text==e}).attr("selected",!0),t.selectpicker("refresh"),$(".table-leads").DataTable().ajax.reload()}),$("[data-can-view-own],[data-can-view]").on("change",function(){var e=$(this).attr("data-can-view-own");view_chk_selector=$(this).parents("tr").find("td input["+(void 0!==e&&!1!==e?"data-can-view":"data-can-view-own")+"]"),view_chk_selector.prop("checked",!1),!0===$(this).prop("checked")?view_chk_selector.prop("disabled",!0):view_chk_selector.prop("disabled",!1)}),"undefined"!=typeof taskid&&""!==taskid&&init_task_modal(taskid),$("body").on("change",'input[name="checklist-box"]',function(){var e=$(this).parents(".checklist").data("checklist-id");$.get(admin_url+"tasks/checkbox_action/"+e+"/"+(!0===$(this).prop("checked")?1:0)),recalculate_checklist_items_progress()}),$("body").on("keyup paste click","textarea[name='checklist-description']",function(e){do_task_checklist_items_height($(this))}),$("body").on("click","#task_comment",function(){tinymce.editors.task_comment&&tinymce.remove("#task_comment"),init_editor("#task_comment",{height:150,auto_focus:!0})}),$("body").on("click",".task-single-delete-timesheet",function(e){if(e.preventDefault(),0==confirm(appLang.confirm_action_prompt))return!1;var t=$(this).data("task-id");$.get($(this).attr("href"),function(){init_task_modal(t),setTimeout(function(){reload_tasks_tables()},20)})}),$("body").on("click",".task-single-add-timesheet",function(e){e.preventDefault();var t=$("body").find('#task-modal input[name="timesheet_start_time"]').val(),a=$("body").find('#task-modal input[name="timesheet_end_time"]').val();if(""!=t&&""!=a){var i={};i.start_time=t,i.end_time=a,i.timesheet_task_id=$(this).data("task-id"),i.note=$("body").find("#task_single_timesheet_note").val(),i.timesheet_staff_id=$("body").find('#task-modal select[name="single_timesheet_staff_id"]').val(),$.post(admin_url+"tasks/log_time",i).done(function(e){1==(e=JSON.parse(e)).success?(init_task_modal(i.timesheet_task_id),alert_float("success",e.message),setTimeout(function(){reload_tasks_tables()},20)):alert_float("warning",e.message)})}}),$("body").on("click",".copy_task_action",function(){var e={};return e.copy_from=$(this).data("task-copy-from"),e.copy_task_assignees=$("body").find("#copy_task_assignees").prop("checked"),e.copy_task_followers=$("body").find("#copy_task_followers").prop("checked"),e.copy_task_checklist_items=$("body").find("#copy_task_checklist_items").prop("checked"),e.copy_task_attachments=$("body").find("#copy_task_attachments").prop("checked"),e.copy_task_status=$("body").find('input[name="copy_task_status"]:checked').val(),$.post(admin_url+"tasks/copy",e).done(function(e){if(1==(e=JSON.parse(e)).success){var t=$("#_task_modal");t.is(":visible")&&t.modal("hide"),init_task_modal(e.new_task_id),reload_tasks_tables()}alert_float(e.alert_type,e.message)}),!1}),$("body").on("click",".new-task-to-milestone",function(e){e.preventDefault();var t=$(this).parents(".milestone-column").data("milestone-id");new_task(admin_url+"tasks/task?rel_type=project&rel_id="+project_id+"&milestone_id="+t)}),$("body").on("shown.bs.modal","#_task_modal",function(e){$(e.currentTarget).hasClass("edit")?""!==$(this).find(".tinymce-task").val().trim()&&init_editor(".tinymce-task",{height:200}):$("body").find("#_task_modal #name").focus(),init_tags_inputs()}),$("body").on("hidden.bs.modal","#_task_modal",function(){tinyMCE.remove(".tinymce-task"),"undefined"!=typeof _ticket_message&&(_ticket_message=void 0),void 0==$(this).attr("data-lead-id")||$(this).attr("data-task-created")||init_lead($(this).attr("data-lead-id")),$("body #_task_modal .datepicker").datetimepicker("destroy"),$("#_task").empty()}),$("body").on("hide.bs.modal","#task-modal",function(){if(1==$("#lightbox").is(":visible"))return!1;"undefined"!=typeof taskAttachmentDropzone&&taskAttachmentDropzone.destroy(),tinyMCE.remove("#task_view_description")}),$("body").on("hidden.bs.modal","#task-modal",function(){$("#task-modal .data").empty()}),$("body").on("shown.bs.modal","#task-modal",function(){init_tags_inputs(),fix_task_modal_left_col_height(),$(document).off("focusin.modal");var e=window.location.href;if(e.indexOf("#comment_")>-1){var t=e.split("#comment_");t=t[t.length-1],$('[data-task-comment-href-id="'+t+'"]').click()}}),$("body").on("blur","#task-modal ul.tagit li.tagit-new input",function(){setTimeout(function(){task_single_update_tags()},100)}),$("body").on("change",'select[name="select-assignees"]',function(){$("body").append('<div class="dt-loader"></div>');var e={};e.assignee=$('select[name="select-assignees"]').val(),""!=e.assignee&&(e.taskid=$(this).attr("data-task-id"),$.post(admin_url+"tasks/add_task_assignees",e).done(function(t){$("body").find(".dt-loader").remove(),t=JSON.parse(t),reload_tasks_tables(),init_task_modal(e.taskid)}))}),$("body").on("change",'select[name="select-followers"]',function(){var e={};e.follower=$('select[name="select-followers"]').val(),""!=e.follower&&(e.taskid=$(this).attr("data-task-id"),$("body").append('<div class="dt-loader"></div>'),$.post(admin_url+"tasks/add_task_followers",e).done(function(t){t=JSON.parse(t),$("body").find(".dt-loader").remove(),init_task_modal(e.taskid)}))}),$("body").on("click",".close-task-stats",function(){$("#task-tracking-stats-modal").modal("hide")}),$("body").on("hidden.bs.modal","#task-tracking-stats-modal",function(){$("#tracking-stats").remove()}),$("body").on("show.bs.modal","#task-tracking-stats-modal",function(){var e=$("body").find("#task-tracking-stats-chart");setTimeout(function(){"undefined"!=typeof task_track_chart&&task_track_chart.destroy(),task_track_chart=new Chart(e,{type:"line",data:task_tracking_stats_data,options:{legend:{display:!1},responsive:!0,maintainAspectRatio:!1,tooltips:{enabled:!0,mode:"single",callbacks:{label:function(e,t){return decimalToHM(e.yLabel)}}},scales:{yAxes:[{ticks:{beginAtZero:!0,min:0,userCallback:function(e,t,a){return decimalToHM(e)}}}]}}})},800)}),$("body").on("shown.bs.modal","#sync_data_proposal_data",function(){"lead"==$("#sync_data_proposal_data").data("rel-type")&&$("#lead-modal .data").eq(0).css("height",$("#sync_data_proposal_data .modal-content").height()+80+"px").css("overflow-x","hidden")}),$("body").on("hidden.bs.modal","#sync_data_proposal_data",function(){"lead"==$("#sync_data_proposal_data").data("rel-type")&&$("#lead-modal .data").prop("style","")}),"undefined"!=typeof c_leadid&&""!=c_leadid&&init_lead(c_leadid),$("body").on("click",".leads-kan-ban .cpicker",function(){var e=$(this).data("color"),t=$(this).parents(".panel-heading-bg").data("status-id");$.post(admin_url+"leads/change_status_color",{color:e,status_id:t})}),$("body").on("click","[lead-edit]",function(e){e.preventDefault(),$("body .lead-view").toggleClass("hide"),$("body .lead-edit").toggleClass("hide")}),$("body").on("click",".new-lead-from-status",function(e){e.preventDefault();var t=$(this).parents(".kan-ban-col").data("col-status-id");init_lead_modal_data(void 0,admin_url+"leads/lead?status_id="+t)}),$("body").on("change","input.include_leads_custom_fields",function(){var e=$(this).val(),t=$(this).data("field-id");2==e?$("#merge_db_field_"+t).removeClass("hide"):$("#merge_db_field_"+t).addClass("hide"),3==e?$("#merge_db_contact_field_"+t).removeClass("hide"):$("#merge_db_contact_field_"+t).addClass("hide")}),calendar_selector.length>0){validate_calendar_form();var i={customButtons:{},header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay,viewFullCalendar,calendarFilter"},editable:!1,eventLimit:parseInt(app_calendar_events_limit)+1,views:{day:{eventLimit:!1}},defaultView:app_default_view_calendar,isRTL:"true"==isRTL,eventStartEditable:!1,timezone:app_timezone,firstDay:parseInt(app_calendar_first_day),year:moment.tz(app_timezone).format("YYYY"),month:moment.tz(app_timezone).format("M"),date:moment.tz(app_timezone).format("DD"),loading:function(e,t){e?$(".dt-loader").removeClass("hide"):$(".dt-loader").addClass("hide")},eventSources:[{url:admin_url+"utilities/get_calendar_data",data:function(){var e={};if($("#calendar_filters").find("input:checkbox:checked").map(function(){e[$(this).attr("name")]=!0}).get(),!jQuery.isEmptyObject(e))return e.calendar_filters=!0,e},type:"POST",error:function(){console.error("There was error fetching calendar data")}}],eventLimitClick:function(e,t){$("#calendar").fullCalendar("gotoDate",e.date),$("#calendar").fullCalendar("changeView","basicDay")},eventRender:function(e,t){t.attr("title",e._tooltip),t.attr("onclick",e.onclick),t.attr("data-toggle","tooltip"),e.url||t.click(function(){view_event(e.eventid)})},dayClick:function(e,t,a){return $("#newEventModal").modal("show"),$.post(admin_url+"misc/format_date",{date:moment(e.format()).locale("en").format("YYYY-MM-DD")}).done(function(e){$("input[name='start'].datetimepicker").val(e)}),!1}};if($("body").hasClass("home")&&(i.customButtons.viewFullCalendar={text:appLang.calendar_expand,click:function(){window.location.href=admin_url+"utilities/calendar"}}),i.customButtons.calendarFilter={text:appLang.filter_by.toLowerCase(),click:function(){slideToggle("#calendar_filters")}},1==is_staff_member&&(""!=google_api&&(i.googleCalendarApiKey=google_api),""!=calendarIDs&&(calendarIDs=JSON.parse(calendarIDs),0!=calendarIDs.length)))if(""!=google_api)for(var n=0;n<calendarIDs.length;n++){var o={};o.googleCalendarId=calendarIDs[n],i.eventSources.push(o)}else console.error("You have setup Google Calendar IDs but you dont have specified Google API key. To setup Google API key navigate to Setup->Settings->Misc");calendar_selector.fullCalendar(i),get_url_param("new_event")&&($("#newEventModal").modal("show"),$("input[name='start'].datetimepicker").val(get_url_param("date")))}$("body").on("change",'select[name="tax"]',function(){var e=$("body").find('select[name="tax2"]'),t=$(this);""!=t.val()?e.prop("disabled",!1):(e.prop("disabled",!0),""!=e.val()&&(t.val(e.val()),e.val(""),t.selectpicker("refresh"))),e.selectpicker("refresh")}),$('input[name="notify_type"]').on("change",function(){var e=$(this).val(),t=$("#specific_staff_notify"),a=$("#role_notify");"specific_staff"==e?(t.removeClass("hide"),a.addClass("hide")):"roles"==e?(t.addClass("hide"),a.removeClass("hide")):"assigned"==e&&(t.addClass("hide"),a.addClass("hide"))}),$("body").on("shown.bs.modal","#lead-modal",function(e){custom_fields_hyperlink(),0==$("body").find('#lead-modal input[name="leadid"]').length&&$("body").find('#lead-modal input[name="name"]').focus()}),$("#lead-modal").on("hidden.bs.modal",function(e){$(this).data("bs.modal",null),$("#lead_reminder_modal").html(""),$("#lead-modal").is(":visible")||history.pushState("",document.title,window.location.pathname+window.location.search),$("body #lead-modal .datetimepicker").datetimepicker("destroy"),"undefined"!=typeof leadAttachmentsDropzone&&leadAttachmentsDropzone.destroy()});var s=1;$("body").on("click",".add_more_attachments",function(){if($(this).hasClass("disabled"))return!1;var e=$('.attachments input[name*="attachments"]').length;if($(this).data("ticket")&&e>=app_maximum_allowed_ticket_attachments)return!1;var t=$(".attachments").find(".attachment").eq(0).clone().appendTo(".attachments");t.find("input").removeAttr("aria-describedby aria-invalid"),t.find(".has-error").removeClass("has-error"),t.find("input").attr("name","attachments["+s+"]").val(""),t.find('p[id*="error"]').remove(),t.find("i").removeClass("fa-plus").addClass("fa-minus"),t.find("button").removeClass("add_more_attachments").addClass("remove_attachment").removeClass("btn-success").addClass("btn-danger"),s++}),$("body").on("click",".remove_attachment",function(){$(this).parents(".attachment").remove()}),$("body").on("hidden.bs.modal","#convert_lead_to_client_modal",function(e){$(this).data("bs.modal",null)}),$("body").on("click",'#lead-modal a[data-toggle="tab"]',function(){"#tab_lead_profile"==this.hash||"#attachments"==this.hash||"#lead_notes"==this.hash||"#lead_activity"==this.hash?window.location.hash=this.hash:history.pushState("",document.title,window.location.pathname+window.location.search)}),$("body").on("click","#lead_enter_activity",function(){var e=$("#lead_activity_textarea").val(),t=$("#lead-modal").find('input[name="leadid"]').val();""!=e&&$.post(admin_url+"leads/add_activity",{leadid:t,activity:e}).done(function(){init_lead_modal_data(t)}).fail(function(e){$("#lead-modal").modal("hide"),alert_float("danger",e.responseText)})}),$("body").on("submit","#lead-modal #lead-notes",function(){var e=$(this),t=$(e).serialize();return $.post(e.attr("action"),t).done(function(e){init_lead_modal_data(e)}).fail(function(e){$("#lead-modal").modal("hide"),alert_float("danger",e.responseText)}),!1});var l={custom_view:"[name='custom_view']",assigned:"[name='view_assigned']",status:"[name='view_status']",source:"[name='view_source']"},d=$(".table-leads");if(d.length){var r=d.find("th");initDataTable(".table-leads",admin_url+"leads?table_leads=true",[r.length-1,0],[r.length-1,0],l,[d.find("th.date-created").index(),"DESC"]),$.each(l,function(e,t){$("select"+t).on("change",function(){d.DataTable().ajax.reload()})})}$("body").on("change",'input[name="contacted_today"]',function(){var e=$(this).prop("checked"),t=$(".lead-select-date-contacted");0==e?t.removeClass("hide"):t.addClass("hide")}),$("body").on("change",'input[name="contacted_indicator"]',function(){var e=$(".lead-select-date-contacted");"yes"==$(this).val()?e.removeClass("hide"):e.addClass("hide")}),$("body").on("click","table.dataTable tbody td:first-child",function(){var e=$(this).parents("tr");if($(this).parents("table").DataTable().row(e).child.isShown()){var t=$(e).next().find("input.onoffswitch-checkbox");if(t.length>0){var a=Math.random().toString(16).slice(2);t.attr("id",a).next().attr("for",a)}}}),$("body").on("click","[data-loading-text]",function(){var e=$(this).data("form");null!=e?$(e).valid()&&$(this).button("loading"):$(this).button("loading")}),$("body").on("click",".close-reminder-modal",function(){$(".reminder-modal-"+$(this).data("rel-type")+"-"+$(this).data("rel-id")).modal("hide")}),$("body").on("shown.bs.tab",'a[data-toggle="tab"]',function(e){$($.fn.dataTable.tables(!0)).DataTable().responsive.recalc()}),$("form").not("#single-ticket-form,#calendar-event-form,#proposal-form").areYouSure(),$("body").on("click",".editor-add-content-notice",function(){$(this).remove(),tinymce.triggerSave()}),$(".bulk_actions").on("change",'input[name="mass_delete"]',function(){var e=$("#bulk_change");1==$(this).prop("checked")&&e.find("select").selectpicker("val",""),e.toggleClass("hide"),$(".mass_delete_separator").toggleClass("hide")}),$("body").on("hidden.bs.modal","#__todo",function(){var e=$("#__todo");e.find('input[name="todoid"]').val(""),e.find('textarea[name="description"]').val(""),e.find(".add-title").addClass("hide"),e.find(".edit-title").addClass("hide")}),$("body").on("shown.bs.modal","#__todo",function(){var e=$("#__todo");e.find('textarea[name="description"]').focus(),""!=e.find('input[name="todoid"]').val()?(e.find(".add-title").addClass("hide"),e.find(".edit-title").removeClass("hide")):(e.find(".add-title").removeClass("hide"),e.find(".edit-title").addClass("hide"))}),$("#top_search_button button").on("click",function(){var e=$("#search_input");e.focus(),$(this).hasClass("search_remove")&&($(this).html('<i class="fa fa-search"></i>').removeClass("search_remove"),original_top_search_val="",$("#search_results").html(""),e.val(""))}),$("body").click(function(e){$(e.target).parents("#top_search_dropdown").hasClass("search-results")||$("#top_search_dropdown").remove()}),$("body").tooltip({selector:'[data-toggle="tooltip"]'}),$("body").popover({selector:'[data-toggle="popover"]'}),$("body").on("click",function(){$(".tooltip").remove()}),$("body").on("click",function(e){$('[data-toggle="popover"],.manual-popover').each(function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||$(this).popover("hide")})}),$("body").on("click","._filter_data ul.dropdown-menu li a,.not-mark-as-read-inline,.not_mark_all_as_read a",function(e){e.stopPropagation(),e.preventDefault()}),$("body").on("click","._delete",function(e){return 1==confirm(appLang.confirm_action_prompt)}),$("body").on("shown.bs.modal",".modal",function(){$("body").addClass("modal-open"),$("body").find("#started-timers-top").parents("li").removeClass("open")}),$("body").on("hidden.bs.modal",".modal",function(e){$(".modal:visible").length&&$(document.body).addClass("modal-open"),$(this).data("bs.modal",null)}),$(".datepicker.activity-log-date").on("change",function(){$(".table-activity-log").DataTable().ajax.reload()}),$("body").on("change",'[name="repeat_every"],[name="recurring"]',function(){var e=$(this).val();"custom"==e?$(".recurring_custom").removeClass("hide"):$(".recurring_custom").addClass("hide"),""!=e&&0!=e?$("body").find("#recurring_ends_on").removeClass("hide"):($("body").find("#recurring_ends_on").addClass("hide"),$("body").find("#recurring_ends_on input").val(""))}),$('select[name="range"]').on("change",function(){var e=$(".period");"period"==$(this).val()?e.removeClass("hide"):(e.addClass("hide"),e.find("input").val(""))}),_validate_form($("#kb_group_form"),{name:"required"},manage_kb_groups),$("#kb_group_modal").on("hidden.bs.modal",function(e){$("#additional").html(""),$("#kb_group_modal input").val(""),$(".add-title").removeClass("hide"),$(".edit-title").removeClass("hide"),$('#kb_group_modal input[name="group_order"]').val($("table tbody tr").length+1)}),$("body").on("change","#mass_select_all",function(){var e,t,a;e=$(this).data("to-table"),t=$(".table-"+e).find("tbody tr"),a=$(this).prop("checked"),$.each(t,function(){$($(this).find("td").eq(0)).find("input").prop("checked",a)})}),$("body").on("show.bs.modal",".modal.email-template",function(){init_editor($(this).data("editor-id"),{urlconverter_callback:"merge_field_format_url"})}),$("body").on("hidden.bs.modal",".modal.email-template",function(){tinymce.remove($(this).data("editor-id"))}),$(".close-customizer").on("click",function(e){e.preventDefault(),setup_menu.addClass("true"==isRTL?"fadeOutRight":"fadeOutLeft"),$.get(admin_url+"misc/set_setup_menu_closed")}),$(".open-customizer").on("click",function(e){e.preventDefault(),setup_menu.hasClass("true"==isRTL?"fadeOutRight":"fadeOutLeft")&&setup_menu.removeClass("true"==isRTL?"fadeOutRight":"fadeOutLeft"),setup_menu.addClass("true"==isRTL?"fadeInRight":"fadeInLeft"),setup_menu.addClass("display-block"),is_mobile()||$.get(admin_url+"misc/set_setup_menu_open"),mainWrapperHeightFix()}),$("body").on("click",".cpicker",function(){var e=$(this).data("color");if($(this).hasClass("cpicker-big"))return!1;$(this).parents(".cpicker-wrapper").find(".cpicker-big").removeClass("cpicker-big").addClass("cpicker-small"),$(this).removeClass("cpicker-small","fast").addClass("cpicker-big","fast"),$(this).hasClass("kanban-cpicker")?($(this).parents(".panel-heading-bg").css("background",e),$(this).parents(".panel-heading-bg").css("border","1px solid "+e)):$(this).hasClass("calendar-cpicker")&&$("body").find('._event input[name="color"]').val(e)}),$("body").on("click",".notification_link",function(){var e=$(this).data("link");e.split("#")[1]||(window.location.href=e)}),$("body").on("click",".notifications a.notification-top, .notification_link",function(e){e.preventDefault();var t,a,i=$(this);t=i.hasClass("notification_link")?i.data("link"):e.currentTarget.href;var n=!0;(t=t.split("#"))[1]&&t[1].indexOf("=")>-1&&(n=!1,a=t[1].split("=")[1],t[1].indexOf("postid")>-1?(postid=a,$(".open_newsfeed").click()):t[1].indexOf("taskid")>-1?init_task_modal(a):t[1].indexOf("leadid")>-1?init_lead(a):t[1].indexOf("eventid")>-1&&view_event(a)),i.hasClass("desktopClick")||i.parent("li").find(".not-mark-as-read-inline").click(),n&&setTimeout(function(){window.location.href=t},50)}),$(".notifications-wrapper").on("show.bs.dropdown",function(){clearInterval(autocheck_notifications_timer_id),notifications_wrapper.find(".notifications").attr("data-total-unread")>0&&$.post(admin_url+"misc/set_notifications_read").done(function(e){1==(e=JSON.parse(e)).success&&(document.title=doc_initial_title,$(".icon-notifications").addClass("hide"))})}),0!=app_auto_check_for_new_notifications&&(autocheck_notifications_timer_id=setInterval(function(){fetch_notifications()},1e3*app_auto_check_for_new_notifications)),init_table_tickets(),init_table_announcements(),init_table_staff_projects();var c=[];if(c.activity_log_date='[name="activity_log_date"]',initDataTable(".table-activity-log",window.location.href,"undefined","undefined",c,[1,"DESC"]),$(".table-invoices").length>0||$(".table-estimates").length>0){var _={},p=$("._hidden_inputs._filters input");$.each(p,function(){_[$(this).attr("name")]='[name="'+$(this).attr("name")+'"]'}),initDataTable(".table-invoices",admin_url+"invoices/list_invoices","undefined","undefined",_,[[3,"DESC"],[0,"DESC"]]),initDataTable(".table-estimates",admin_url+"estimates/list_estimates","undefined","undefined",_,[[3,"DESC"],[0,"DESC"]])}var m,u={};m=$("._hidden_inputs._filters._tasks_filters input"),$.each(m,function(){u[$(this).attr("name")]='[name="'+$(this).attr("name")+'"]'});var f=[$(".table-tasks").find("th").length-1],h=2,v=admin_url+"tasks";$("body").hasClass("tasks_page")&&(f.push(0),h=3,v+="?bulk_actions=true"),_table_api=initDataTable(".table-tasks",v,f,f,u,[h,"ASC"]),_table_api&&$("body").hasClass("home")&&_table_api.column(4).visible(!1,!1).column(6).visible(!1,!1).column(5).visible(!1,!1).columns.adjust(),$("#send_file").on("show.bs.modal",function(e){var t=$("#send_file");t.find('input[name="filetype"]').val($($(e.relatedTarget)).data("filetype")),t.find('input[name="file_path"]').val($($(e.relatedTarget)).data("path")),t.find('input[name="file_name"]').val($($(e.relatedTarget)).data("file-name")),$('input[name="email"]').length>0&&t.find('input[name="send_file_email"]').val($('input[name="email"]').val())}),$("body").on("change",'input[name="send_set_password_email"]',function(){$("body").find(".client_password_set_wrapper").toggleClass("hide")}),$("body").on("change",'.todo input[type="checkbox"]',function(){var e=!0===$(this).prop("checked")?1:0,t=$(this).val();window.location.href=admin_url+"todo/change_todo_status/"+t+"/"+e});var g=$(".todos-sortable");g.length>0&&(g=g.sortable({connectWith:".todo",items:"li",handle:".dragger",appendTo:"body",update:function(e,t){this===t.item.parent()[0]&&update_todo_items()}})),$("body").on("click",".open_newsfeed,.close_newsfeed",function(e){if(e.preventDefault(),void 0===$(this).data("close")){var t=admin_url+"newsfeed/get_data";$.get(t,function(e){$("#newsfeed").html(e),load_newsfeed(postid),init_newsfeed_form(),init_selectpicker(),include_lightbox(),init_lightbox()})}else!0===$(this).data("close")&&(newsFeedDropzone.destroy(),$("#newsfeed").html(""),total_new_post_files=0,newsfeed_posts_page=0,track_load_post_likes=0,track_load_comment_likes=0,postid=void 0);$("#newsfeed").toggleClass("hide"),$("body").toggleClass("noscroll")}),$("[data-newsfeed-auto]").length>0&&$(".open_newsfeed").click(),$("body").on("keyup",".comment-input input",function(e){13==e.keyCode&&add_comment(this)}),$("#modal_post_likes").on("show.bs.modal",function(e){track_load_post_likes=0,$("#modal_post_likes_wrapper").empty(),$(".likes_modal .modal-footer").removeClass("hide");var t=$(e.relatedTarget),a=$(t).data("postid");post_likes_total_pages=$(t).data("total-pages"),$(".load_more_post_likes").attr("data-postid",a),load_post_likes(a)}),$("#modal_post_comment_likes").on("show.bs.modal",function(e){$("#modal_comment_likes_wrapper").empty(),track_load_comment_likes=0,$(".likes_modal .modal-footer").removeClass("hide");var t=$(e.relatedTarget),a=$(t).data("commentid");comment_likes_total_pages=$(t).data("total-pages"),$(".load_more_post_comment_likes").attr("data-commentid",a),load_comment_likes(a)}),$(".load_more_post_likes").on("click",function(e){e.preventDefault(),load_post_likes($(this).data("postid"))}),$(".load_more_post_comment_likes").on("click",function(e){e.preventDefault(),load_comment_likes($(this).data("commentid"))}),$(".add-attachments").on("click",function(e){e.preventDefault(),$("#post-attachments").toggleClass("hide")}),$("body").on("change","#post-visibility",function(){var e=$(this).val();null!=e&&e.indexOf("all")>-1&&e.length>1&&(e.splice(0,1),$(this).selectpicker("val",e))}),init_invoices_total(),init_expenses_total(),init_estimates_total(),init_items_sortable(),$(".settings-textarea-merge-field").on("click",function(e){e.preventDefault();var t=$(this).text().trim(),a=$('textarea[name="settings['+$(this).data("to")+']"]');a.val(a.val()+"\n"+t)}),$("body").hasClass("estimates-pipeline")&&estimate_pipeline_open($('input[name="estimateid"]').val()),$("body").hasClass("proposals-pipeline")&&proposal_pipeline_open($('input[name="proposalid"]').val()),$("body").on("submit","._transaction_form",function(){return calculate_total(),reorder_items(),$('select[name="currency"]').prop("disabled",!1),$('select[name="project_id"]').prop("disabled",!1),!0}),$("body").on("click",".estimate-form-submit,.proposal-form-submit,.invoice-form-submit",function(){var e=$(this).parents("form:first");$(this).hasClass("invoice-form-submit")?(e.valid()&&($(this).hasClass("save-as-draft")?e.append(hidden_input("save_as_draft","true")):$(this).hasClass("save-and-send")&&e.append(hidden_input("save_and_send","true")),$(this).attr("disabled",!0)),e.submit()):e.valid()&&($(this).hasClass("save-and-send")&&e.append(hidden_input("save_and_send","true")),$(this).attr("disabled",!0)),e.submit()}),$("body").on("submit","#estimate-notes",function(){var e=$("#estimate-notes");if(""!=e.find('textarea[name="description"]').val()){var t=$(this),a=$(t).serialize();return $.post(t.attr("action"),a).done(function(t){get_estimate_notes(t),e.find('textarea[name="description"]').val("")}),!1}}),$("body").on("change",'input[name="show_quantity_as"]',function(){$("body").find("th.qty").html($(this).data("text"))}),$("body").on("change",'div.estimate input[name="date"]',function(){do_prefix_year($(this).val())}),$("body").on("change",'div.invoice input[name="date"],div.estimate input[name="date"]',function(){var e=$(this).val();if(do_prefix_year(e),!($('input[name="isedit"]').length>0)){var t="duedate",a=admin_url+"invoices/get_due_date";$("body").find("div.estimate").length>0&&(a=admin_url+"estimates/get_due_date",t="expirydate"),""!=e?$.post(a,{date:e}).done(function(e){e&&$('input[name="'+t+'"]').val(e)}):$('input[name="'+t+'"]').val("")}}),$("#sales_attach_file").on("hidden.bs.modal",function(e){$("#sales_uploaded_files_preview").empty(),$(".dz-file-preview").empty()}),"undefined"!=typeof Dropbox&&$("#dropbox-chooser-sales").length>0&&document.getElementById("dropbox-chooser-sales").appendChild(Dropbox.createChooseButton({success:function(e){var t={};t.rel_id=$("body").find('input[name="_attachment_sale_id"]').val(),t.type=$("body").find('input[name="_attachment_sale_type"]').val(),t.files=e,t.external="dropbox",$.post(admin_url+"misc/add_sales_external_attachment",t).done(function(){"invoice"==t.type?init_invoice(t.rel_id):"estimate"==t.type?$("body").hasClass("estimates-pipeline")?estimate_pipeline_open(t.rel_id):init_estimate(t.rel_id):"proposal"==t.type&&($("body").hasClass("proposals-pipeline")?proposal_pipeline_open(t.rel_id):init_proposal(t.rel_id)),$("#sales_attach_file").modal("hide")})},linkType:"preview",extensions:app_allowed_files.split(",")})),$("#sales-upload").length>0&&new Dropzone("#sales-upload",{createImageThumbnails:!0,dictFileTooBig:appLang.file_exceeds_maxfile_size_in_form,dictDefaultMessage:appLang.drop_files_here_to_upload,dictFallbackMessage:appLang.browser_not_support_drag_and_drop,dictRemoveFile:appLang.remove_file,sending:function(e,t,a){a.append("rel_id",$("body").find('input[name="_attachment_sale_id"]').val()),a.append("type",$("body").find('input[name="_attachment_sale_type"]').val())},complete:function(e){this.removeFile(e)},success:function(e,t){t=JSON.parse(t);var a,i,n=$("body").find('input[name="_attachment_sale_type"]').val();a="download/file/sales_attachment/",i="delete_"+n+"_attachment","invoice"==n?init_invoice(t.rel_id):"estimate"==n?$("body").hasClass("estimates-pipeline")?estimate_pipeline_open(t.rel_id):init_estimate(t.rel_id):"proposal"==n&&($("body").hasClass("proposals-pipeline")?proposal_pipeline_open(t.rel_id):init_proposal(t.rel_id));var o="";1==t.success&&(o+='<div class="display-block sales-attach-file-preview" data-attachment-id="'+t.attachment_id+'">',o+='<div class="col-md-10">',o+='<div class="pull-left"><i class="attachment-icon-preview fa fa-file-o"></i></div>',o+='<a href="'+site_url+a+t.key+'" target="_blank">'+t.file_name+"</a>",o+='<p class="text-muted">'+t.filetype+"</p>",o+="</div>",o+='<div class="col-md-2 text-right">',o+='<a href="#" class="text-danger" onclick="'+i+"("+t.attachment_id+'); return false;"><i class="fa fa-times"></i></a>',o+="</div>",o+='<div class="clearfix"></div><hr/>',o+="</div>",$("#sales_uploaded_files_preview").append(o))},maxFilesize:(max_php_ini_upload_size_bytes/1048576).toFixed(0),acceptedFiles:app_allowed_files,error:function(e,t){alert_float("danger",t)}}),$("body").on("show.bs.modal","#sales_item_modal",function(e){_validate_form($("#invoice_item_form"),{description:"required",rate:{required:!0}},manage_invoice_items),$(".affect-warning").addClass("hide");var t=$("#sales_item_modal");t.find("input").val(""),t.find("textarea").val(""),t.find("select").selectpicker("val",""),$('select[name="tax2"]').selectpicker("val","").change(),$('select[name="tax"]').selectpicker("val","").change(),t.find(".add-title").removeClass("hide"),t.find(".edit-title").addClass("hide");var a=$(e.relatedTarget).data("id");void 0!==a&&($(".affect-warning").removeClass("hide"),$('input[name="itemid"]').val(a),$.get(admin_url+"invoice_items/get_item_by_id/"+a,function(e){t.find('input[name="description"]').val(e.description),t.find('textarea[name="long_description"]').val(e.long_description.replace(/(<|&lt;)br\s*\/*(>|&gt;)/g," ")),t.find('input[name="rate"]').val(e.rate),t.find('input[name="unit"]').val(e.unit),$('select[name="tax"]').selectpicker("val",e.taxid).change(),$('select[name="tax2"]').selectpicker("val",e.taxid_2).change(),t.find("#group_id").selectpicker("val",e.group_id),$.each(e,function(e,a){e.indexOf("rate_currency_")>-1&&t.find('input[name="'+e+'"]').val(a)}),t.find(".add-title").addClass("hide"),t.find(".edit-title").removeClass("hide")},"json"))}),$("body").on("hidden.bs.modal","#sales_item_modal",function(e){$("#item_select").selectpicker("val","")}),$("body").on("click",".invoice-send-to-client",function(e){e.preventDefault(),$("#invoice_send_to_client_modal").modal("show")}),$("body").on("click",".estimate-send-to-client",function(e){e.preventDefault(),$("#estimate_send_to_client_modal").modal("show")}),$("body").on("click",".close-send-template-modal",function(){$("#estimate_send_to_client_modal").modal("hide"),$("#proposal_send_to_customer").modal("hide")}),$("body").on("change","#include_shipping",function(){var e=$("#shipping_details");1==$(this).prop("checked")?e.removeClass("hide"):e.addClass("hide")}),$("body").on("click",".save-shipping-billing",function(e){init_billing_and_shipping_details()}),$("body").on("change",'select[name="currency"]',function(){init_currency_symbol()}),$("body").on("change",'input[name="adjustment"],select.tax',function(){calculate_total()}),$("body").on("change",'select[name="discount_type"]',function(){""==$(this).val()&&$('input[name="discount_percent"]').val(0),calculate_total()}),$("body").on("change",'input[name="discount_percent"]',function(){if(""==$('select[name="discount_type"]').val()&&0!=$(this).val())return alert("You need to select discount type"),$("html,body").animate({scrollTop:0},"slow"),$("#wrapper").highlight($('label[for="discount_type"]').text()),setTimeout(function(){$("#wrapper").unhighlight()},3e3),!1;1==$(this).valid()&&calculate_total()}),$("body").on("change",'select[name="item_select"]',function(){var e=$(this).selectpicker("val");""!=e&&"newitem"!==e?add_item_to_preview(e):"newitem"==e&&$("#sales_item_modal").modal("show")}),$("body").on("change",'select[name="task_select"]',function(){""!=$(this).selectpicker("val")&&add_task_to_preview_as_item($(this).selectpicker("val"))}),$("body").on("change",'select[name="paymentmode"]',function(){var e=$(".do_not_redirect");$.isNumeric($(this).val())?e.addClass("hide"):e.removeClass("hide")}),$("body").on("change",'.f_client_id select[name="clientid"]',function(){var e=$(this).val(),t=$('select[name="project_id"]'),a=t.html("").clone(),i=$(".projects-wrapper");if(t.selectpicker("destroy").remove(),t=a,$("#project_ajax_search_wrapper").append(a),init_ajax_project_search_by_customer_id(),clear_billing_and_shipping_details(),!e)return $("#merge").empty(),$("#expenses_to_bill").empty(),$("#invoice_top_info").addClass("hide"),i.addClass("hide"),!1;var n=$("body").find('input[name="merge_current_invoice"]').val();$.get(admin_url+"invoices/client_change_data/"+e+"/"+n,function(e){$("#merge").html(e.merge_info);var t=$("#expenses_to_bill");0==t.length?e.expenses_bill_info="":t.html(e.expenses_bill_info),""!=e.merge_info||""!=e.expenses_bill_info?$("#invoice_top_info").removeClass("hide"):$("#invoice_top_info").addClass("hide");for(var a in bs_fields)bs_fields[a].indexOf("billing")>-1&&(bs_fields[a].indexOf("country")>-1?$('select[name="'+bs_fields[a]+'"]').selectpicker("val",e.billing_shipping[0][bs_fields[a]]):$('input[name="'+bs_fields[a]+'"]').val(e.billing_shipping[0][bs_fields[a]]));empty(e.billing_shipping[0].shipping_street)||($('input[name="include_shipping"]').prop("checked",!0),$('input[name="include_shipping"]').change());for(var a in bs_fields)bs_fields[a].indexOf("shipping")>-1&&(bs_fields[a].indexOf("country")>-1?$('select[name="'+bs_fields[a]+'"]').selectpicker("val",e.billing_shipping[0][bs_fields[a]]):$('input[name="'+bs_fields[a]+'"]').val(e.billing_shipping[0][bs_fields[a]]));init_billing_and_shipping_details();var n=e.client_currency,o=$("body").find('.accounting-template select[name="currency"]');0!=(n=parseInt(n))?o.val(n):o.val(o.data("base"));var s=$("#task_select");if(s.length>0){var l;s.find("option").filter(function(){return this.value||$.trim(this.value).length>0||$.trim(this.text).length>0}).remove(),$.each(e.billable_tasks,function(e,t){l=" ",1==t.started_timers?l+='disabled class="text-danger important" data-subtext="'+appLang.invoice_task_billable_timers_found+'"':l+='data-subtext="'+t.rel_name+'"',s.append('<option value="'+t.id+'"'+l+">"+t.name+"</option>")}),s.selectpicker("refresh")}!0===e.customer_has_projects?i.removeClass("hide"):i.addClass("hide"),o.selectpicker("refresh"),init_currency_symbol()},"json")}),0==$('input[name="isedit"]').length&&$('.f_client_id select[name="clientid"]').change(),$("body").on("click","#get_shipping_from_customer_profile",function(e){e.preventDefault();var t=$("#include_shipping");0==t.prop("checked")&&(t.prop("checked",!0),$("#shipping_details").removeClass("hide"));var a=$('select[name="clientid"]').val();""!=a&&$.get(admin_url+"clients/get_customer_billing_and_shipping_details/"+a,function(e){$('input[name="shipping_street"]').val(e[0].shipping_street),$('input[name="shipping_city"]').val(e[0].shipping_city),$('input[name="shipping_state"]').val(e[0].shipping_state),$('input[name="shipping_zip"]').val(e[0].shipping_zip),$('select[name="shipping_country"]').selectpicker("val",e[0].shipping_country)},"json")}),"undefined"!=typeof accounting&&(accounting.settings.currency.decimal=app_decimal_separator,accounting.settings.currency.thousand=app_thousand_separator,accounting.settings.currency.precision=app_decimal_places,accounting.settings.number.thousand=app_thousand_separator,accounting.settings.number.decimal=app_decimal_separator,accounting.settings.number.precision=app_decimal_places,calculate_total()),$("body").on("change",'input[name="invoices_to_merge[]"]',function(){var e=$(this).prop("checked"),t=$(this).val();1==e?$.get(admin_url+"invoices/get_merge_data/"+t,function(e){$.each(e.items,function(e,a){""!=a.rel_type&&("task"==a.rel_type?$('input[name="task_id"]').val(a.item_related_formatted_for_input):"expense"==a.rel_type&&$('input[name="expense_id"]').val(a.item_related_formatted_for_input)),add_item_to_table(a,"undefined",t)})},"json"):$("body").find('[data-merge-invoice="'+t+'"]').remove()}),$("body").on("change",'input[name="bill_expenses[]"]',function(){var e=$(this).prop("checked"),t=$(this).val();1==e?$.get(admin_url+"invoices/get_bill_expense_data/"+t,function(e){$('input[name="expense_id"]').val(t),add_item_to_table(e,"undefined","undefined",t)},"json"):($("body").find('[data-bill-expense="'+t+'"]').remove(),$("body").find('#billed-expenses input[value="'+t+'"]').remove())}),$("body").on("change",".invoice_inc_expense_additional_info input",function(){var e,t=$(this).attr("data-content"),a=$("[data-bill-expense="+$(this).attr("data-id")+"] .item_long_description");current_desc_val=a.val(),current_desc_val=current_desc_val.trim(),""!=t&&(1==$(this).prop("checked")?(e=current_desc_val+"\n"+t,a.val(e.trim())):(a.val(current_desc_val.replace("\n"+t,"")),a.val(current_desc_val.replace(t,""))))})}),$(document).keyup(function(e){27==e.keyCode&&$(".modal").is(":visible")&&1==$(".modal:visible").length&&$("body").find('.modal:visible [onclick^="close_modal_manually"]').eq(0).click()}),$("#newsfeed").scroll(function(e){var t=$(e.currentTarget);t[0].scrollHeight-t.scrollTop()==t.outerHeight()&&load_newsfeed(),$("#newsfeed .close_newsfeed").css("top",$(this).scrollTop()+20+"px")}),$(function(){_validate_form($("body").find("#leads-status-form"),{name:"required"},manage_leads_statuses),$("#status").on("hidden.bs.modal",function(e){$("#additional").html(""),$("#status input").val(""),$(".add-title").removeClass("hide"),$(".edit-title").removeClass("hide"),$('#status input[name="statusorder"]').val($("table tbody tr").length+1)})});